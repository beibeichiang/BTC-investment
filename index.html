<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>锚与帆 | 战略指挥舱 v3.3 (Light)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入 Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        btc: '#F59E0B', // 琥珀色/橙色
                        eth: '#8B5CF6', // 经典紫色
                        ada: '#2563EB', // 鲜亮的蓝色
                        usdt: '#10B981', // 翠绿色
                        bg: '#F3F4F6', // 浅灰背景
                        card: '#FFFFFF', // 纯白卡片
                        border: '#E5E7EB', // 边框灰
                        textMain: '#111827', // 深黑文字
                        textMuted: '#6B7280' // 次要文字
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #F3F4F6;
            color: #1F2937;
        }
        /* 卡片样式：纯白底 + 柔和阴影 */
        .panel {
            background-color: #FFFFFF;
            border: 1px solid #E5E7EB;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: box-shadow 0.2s;
        }
        .panel:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .input-group {
            background-color: #F9FAFB; /* 极浅灰输入框背景 */
            border: 1px solid #D1D5DB;
            transition: all 0.2s;
        }
        .input-group:focus-within {
            border-color: #6B7280;
            background-color: #FFFFFF;
            box-shadow: 0 0 0 2px rgba(229, 231, 235, 0.5);
        }
        .input-field {
            background: transparent;
            outline: none;
            width: 100%;
            color: #111827;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        /* 进度条动画 */
        .progress-segment {
            transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }
        /* 滚动条 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #F3F4F6; }
        ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 text-base">

    <div class="max-w-[1600px] mx-auto space-y-8">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 pb-4 border-b border-gray-200">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-white border border-gray-200 rounded-xl flex items-center justify-center text-btc shadow-sm">
                    <i class="ph-fill ph-anchor text-3xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 tracking-tight">锚与帆 <span class="text-gray-400 font-normal text-lg ml-1">v3.3</span></h1>
                    <p class="text-gray-500 text-sm font-medium">周期套利战略模拟 (Day Mode)</p>
                </div>
            </div>
            
            <!-- 顶部数据条 -->
            <div class="flex items-center gap-4 bg-white px-5 py-3 rounded-xl border border-gray-200 shadow-sm">
                <div class="flex items-center gap-4 text-sm font-mono">
                    <div class="flex items-center gap-2">
                        <span class="w-2.5 h-2.5 rounded-full bg-btc"></span>
                        <span class="text-gray-500 font-bold">BTC</span>
                        <span class="text-gray-900 font-bold" id="price-btc">$--</span>
                    </div>
                    <div class="w-px h-4 bg-gray-300"></div>
                    <div class="flex items-center gap-2">
                        <span class="w-2.5 h-2.5 rounded-full bg-eth"></span>
                        <span class="text-gray-500 font-bold">ETH</span>
                        <span class="text-gray-900 font-bold" id="price-eth">$--</span>
                    </div>
                    <div class="w-px h-4 bg-gray-300"></div>
                    <div class="flex items-center gap-2">
                        <span class="w-2.5 h-2.5 rounded-full bg-ada"></span>
                        <span class="text-gray-500 font-bold">ADA</span>
                        <span class="text-gray-900 font-bold" id="price-ada">$--</span>
                    </div>
                </div>
                
                <div class="w-px h-8 bg-gray-200 mx-2"></div>

                <div class="flex flex-col items-end leading-none">
                    <span class="text-[11px] text-gray-400 uppercase font-bold tracking-wider">Ahr999 Index</span>
                    <span class="text-lg font-mono font-bold text-gray-800" id="ahr-value">--</span>
                </div>
                
                <button id="refresh-btn" class="p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="ph-bold ph-arrows-clockwise text-xl"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
            
            <!-- 左侧：参数设置 (3列) -->
            <div class="xl:col-span-3 space-y-6">
                
                <!-- 1. 持仓输入 -->
                <div class="panel rounded-xl p-5">
                    <h2 class="text-gray-800 font-bold mb-4 flex items-center gap-2 text-sm uppercase tracking-wide">
                        <div class="p-1.5 bg-blue-50 text-blue-600 rounded-md"><i class="ph-bold ph-wallet"></i></div>
                        1. 当前持仓 (起点)
                    </h2>
                    <div class="space-y-3">
                        <div class="input-group rounded-lg p-3 flex justify-between items-center border-l-4 border-l-btc">
                            <label class="text-sm text-gray-600 font-bold">⚓ BTC</label>
                            <input type="number" id="currentBtc" class="input-field text-right text-lg" placeholder="0.00">
                        </div>
                        <div class="input-group rounded-lg p-3 flex justify-between items-center border-l-4 border-l-eth">
                            <label class="text-sm text-gray-600 font-bold">⛵ ETH</label>
                            <input type="number" id="currentEth" class="input-field text-right text-lg">
                        </div>
                        <div class="input-group rounded-lg p-3 flex justify-between items-center border-l-4 border-l-ada">
                            <label class="text-sm text-gray-600 font-bold">⛵ ADA</label>
                            <input type="number" id="currentAda" class="input-field text-right text-lg">
                        </div>
                    </div>
                </div>

                <!-- 2. 牛顶目标 -->
                <div class="panel rounded-xl p-5">
                    <h2 class="text-gray-800 font-bold mb-4 flex items-center gap-2 text-sm uppercase tracking-wide">
                        <div class="p-1.5 bg-red-50 text-red-600 rounded-md"><i class="ph-bold ph-trend-up"></i></div>
                        2. 牛顶卖出价 (USD)
                    </h2>
                    <div class="space-y-3">
                        <div class="input-group rounded-lg p-3 flex justify-between items-center bg-white shadow-sm">
                            <label class="text-sm text-gray-600 font-medium">BTC 目标</label>
                            <input type="number" id="bullBtcPrice" class="input-field text-right text-xl font-bold text-gray-900" value="150000">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="input-group rounded-lg p-3">
                                <label class="block text-xs text-gray-500 mb-1 font-medium">ETH 卖价</label>
                                <input type="number" id="bullEthPrice" class="input-field text-base" value="8000">
                            </div>
                            <div class="input-group rounded-lg p-3">
                                <label class="block text-xs text-gray-500 mb-1 font-medium">ADA 卖价</label>
                                <input type="number" id="bullAdaPrice" class="input-field text-base" value="5">
                            </div>
                        </div>
                        <div class="mt-2 p-3 bg-red-50 rounded-lg border border-red-100 text-xs text-red-600 flex gap-2 items-start font-medium">
                            <i class="ph-fill ph-warning-circle mt-0.5 text-lg"></i>
                            <span>纪律：清空 ETH/ADA，核心 BTC 锁仓不动。</span>
                        </div>
                    </div>
                </div>

                <!-- 3. 熊底抄底 -->
                <div class="panel rounded-xl p-5">
                    <h2 class="text-gray-800 font-bold mb-4 flex items-center gap-2 text-sm uppercase tracking-wide">
                        <div class="p-1.5 bg-emerald-50 text-emerald-600 rounded-md"><i class="ph-bold ph-magnet"></i></div>
                        3. 熊底接回价 (USD)
                    </h2>
                    
                    <div class="bg-emerald-50 p-3 rounded-lg border border-emerald-100 mb-4">
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-xs text-emerald-700 font-bold">Ahr999 抄底线 (0.45)</span>
                            <span class="text-sm font-mono font-bold text-emerald-600" id="ahr-target-price">$ --</span>
                        </div>
                        <button id="apply-smart-price" class="w-full py-1.5 bg-white text-emerald-600 text-xs font-bold rounded border border-emerald-200 hover:bg-emerald-600 hover:text-white transition-colors shadow-sm">
                            应用此建议价格
                        </button>
                    </div>

                    <div class="input-group rounded-lg p-3 border-l-4 border-l-usdt bg-white shadow-sm">
                        <label class="block text-xs text-gray-500 mb-1 font-medium">您的 BTC 挂单价</label>
                        <input type="number" id="bearBuyPrice" class="input-field text-xl font-bold text-gray-900">
                    </div>
                </div>

            </div>

            <!-- 右侧：推演结果 (9列) -->
            <div class="xl:col-span-9 space-y-8">
                
                <!-- 主流程图 -->
                <div class="space-y-4">
                    
                    <!-- 阶段 1 -->
                    <div class="panel rounded-xl p-6 flex flex-col md:flex-row gap-8 items-center md:items-stretch border-t-4 border-t-blue-500">
                        <!-- 左侧：大数字 -->
                        <div class="md:w-1/4 flex flex-col justify-center min-w-[200px]">
                            <div class="text-xs text-blue-600 font-bold uppercase mb-2 tracking-widest">Phase 1: 起点</div>
                            <div class="text-4xl font-mono font-bold text-gray-900 tracking-tighter" id="start-total-btc">--</div>
                            <div class="text-sm text-gray-500 font-mono mt-1 font-medium" id="start-total-usd">$ --</div>
                        </div>
                        
                        <!-- 右侧：详情 -->
                        <div class="flex-1 w-full flex flex-col justify-center gap-4">
                            <!-- 进度条 -->
                            <div class="w-full h-4 bg-gray-200 rounded-full overflow-hidden flex shadow-inner" id="bar-start"></div>
                            
                            <!-- 数据表格 -->
                            <div class="grid grid-cols-3 gap-6 text-sm">
                                <div class="bg-gray-50 p-2 rounded border border-gray-100">
                                    <div class="text-gray-500 mb-1 flex items-center gap-1.5 text-xs font-bold uppercase"><div class="w-2 h-2 bg-btc rounded-full"></div>BTC (锚)</div>
                                    <div class="font-mono font-bold text-gray-800 text-base" id="start-btc-val">--</div>
                                </div>
                                <div class="bg-gray-50 p-2 rounded border border-gray-100">
                                    <div class="text-gray-500 mb-1 flex items-center gap-1.5 text-xs font-bold uppercase"><div class="w-2 h-2 bg-eth rounded-full"></div>ETH</div>
                                    <div class="font-mono font-bold text-gray-800 text-base" id="start-eth-val">--</div>
                                </div>
                                <div class="bg-gray-50 p-2 rounded border border-gray-100">
                                    <div class="text-gray-500 mb-1 flex items-center gap-1.5 text-xs font-bold uppercase"><div class="w-2 h-2 bg-ada rounded-full"></div>ADA</div>
                                    <div class="font-mono font-bold text-gray-800 text-base" id="start-ada-val">--</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 连接线 -->
                    <div class="flex justify-center -my-3 relative z-10">
                        <div class="bg-white border border-gray-200 rounded-full p-1.5 text-gray-400 shadow-sm">
                            <i class="ph-bold ph-arrow-down text-xl"></i>
                        </div>
                    </div>

                    <!-- 阶段 2 -->
                    <div class="panel rounded-xl p-6 flex flex-col md:flex-row gap-8 items-center md:items-stretch border-t-4 border-t-red-500 relative overflow-hidden">
                        <div class="absolute right-0 top-0 w-48 h-48 bg-red-100 rounded-full blur-3xl pointer-events-none opacity-50"></div>
                        
                        <!-- 左侧：大数字 -->
                        <div class="md:w-1/4 flex flex-col justify-center min-w-[200px]">
                            <div class="text-xs text-red-600 font-bold uppercase mb-2 tracking-widest">Phase 2: 牛顶</div>
                            <div class="text-4xl font-mono font-bold text-gray-900 tracking-tighter" id="bull-total-btc">--</div>
                            <div class="text-sm text-gray-500 font-mono mt-1 font-medium">峰值: <span id="bull-total-usd" class="text-gray-700">--</span></div>
                        </div>

                        <!-- 右侧：详情 -->
                        <div class="flex-1 w-full flex flex-col justify-center gap-4 relative z-10">
                            <div class="flex justify-between items-end">
                                <div class="w-full h-4 bg-gray-200 rounded-full overflow-hidden flex mr-6 shadow-inner" id="bar-bull"></div>
                                <div class="text-right min-w-max bg-white/80 backdrop-blur px-3 py-1.5 rounded-lg border border-green-200 shadow-sm">
                                    <div class="text-[10px] text-usdt font-black uppercase mb-0.5">收割弹药 (USDT)</div>
                                    <div class="text-xl font-mono font-bold text-usdt leading-none" id="harvested-ammo">--</div>
                                </div>
                            </div>

                            <div class="grid grid-cols-3 gap-6 text-sm border-t border-gray-100 pt-3">
                                <div class="opacity-60">
                                    <div class="text-gray-500 mb-1 text-xs font-bold">BTC (保留)</div>
                                    <div class="font-mono text-gray-700" id="bull-btc-val">--</div>
                                </div>
                                <div>
                                    <div class="text-red-500 mb-1 text-xs font-bold">ETH (卖出)</div>
                                    <div class="font-mono font-bold text-gray-900" id="bull-eth-val">--</div>
                                </div>
                                <div>
                                    <div class="text-red-500 mb-1 text-xs font-bold">ADA (卖出)</div>
                                    <div class="font-mono font-bold text-gray-900" id="bull-ada-val">--</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 连接线 -->
                    <div class="flex justify-center -my-3 relative z-10">
                        <div class="bg-white border border-gray-200 rounded-full p-1.5 text-gray-400 shadow-sm">
                            <i class="ph-bold ph-arrow-down text-xl"></i>
                        </div>
                    </div>

                    <!-- 阶段 3 -->
                    <div class="panel rounded-xl p-6 flex flex-col md:flex-row gap-8 items-center md:items-stretch border-t-4 border-t-usdt bg-gradient-to-b from-green-50/50 to-white">
                        
                        <!-- 左侧：大数字 -->
                        <div class="md:w-1/4 flex flex-col justify-center min-w-[200px]">
                            <div class="text-xs text-usdt font-bold uppercase mb-2 tracking-widest">Phase 3: 最终</div>
                            <div class="text-5xl font-mono font-bold text-btc tracking-tighter drop-shadow-sm" id="end-total-btc">--</div>
                            <div class="text-sm text-gray-500 font-mono mt-1 font-medium">熊底价值: <span id="end-total-usd" class="text-gray-700">--</span></div>
                        </div>

                        <!-- 右侧：详情 -->
                        <div class="flex-1 w-full flex flex-col justify-center gap-4">
                            <div class="w-full h-5 bg-gray-200 rounded-full overflow-hidden flex shadow-inner" id="bar-end"></div>
                            
                            <div class="grid grid-cols-2 gap-6 text-sm pt-1">
                                <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex justify-between items-center">
                                    <div>
                                        <div class="text-gray-500 text-[10px] font-bold uppercase mb-0.5">⚓ 原始锚仓位</div>
                                        <div class="font-mono text-btc font-bold text-lg" id="end-anchor-val">--</div>
                                    </div>
                                    <div class="text-right text-gray-400 font-mono text-xs" id="end-anchor-detail">--</div>
                                </div>
                                <div class="bg-green-50 p-3 rounded-lg border border-green-200 shadow-sm flex justify-between items-center">
                                    <div>
                                        <div class="text-usdt text-[10px] font-bold uppercase mb-0.5">⛵ 帆带回利润</div>
                                        <div class="font-mono text-usdt font-bold text-lg" id="end-sail-val">--</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-usdt font-mono font-black text-xl" id="sail-multiplier">--x</div>
                                        <div class="text-green-600/60 font-mono text-xs" id="end-sail-detail">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- 图表区 -->
                <div class="panel rounded-xl p-6 h-80 bg-white">
                    <canvas id="growthChart"></canvas>
                </div>

            </div>
        </div>
    </div>

<script>
    // --- State Management ---
    const state = {
        holdings: { btc: 0.0871, eth: 4.5603, ada: 45029.7432 },
        prices: { btc: 0, eth: 0, ada: 0 },
        targets: { btc: 150000, eth: 8000, ada: 5 },
        bear: { buyPrice: 69000 },
        ahr: { value: 0, targetPrice: 0 }
    };

    // --- DOM Helpers ---
    const $ = (id) => document.getElementById(id);
    let chartInstance = null;

    // --- Formatting ---
    const fmt = {
        usd: (n, d=0) => '$' + new Intl.NumberFormat('en-US', { maximumFractionDigits: d }).format(n),
        btc: n => new Intl.NumberFormat('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 4 }).format(n) + ' BTC',
        pct: n => n.toFixed(1) + '%',
        num: (n, d=2) => new Intl.NumberFormat('en-US', { maximumFractionDigits: d }).format(n)
    };

    // --- Initialization ---
    function init() {
        loadState();
        bindEvents();
        fetchData();
    }

    // --- Data & Logic ---
    function bindEvents() {
        const bind = (id, obj, key) => {
            const el = $(id);
            if(el) {
                el.value = obj[key];
                el.addEventListener('input', (e) => { 
                    obj[key] = parseFloat(e.target.value) || 0; 
                    update(); 
                });
            }
        };

        bind('currentBtc', state.holdings, 'btc');
        bind('currentEth', state.holdings, 'eth');
        bind('currentAda', state.holdings, 'ada');
        bind('bullBtcPrice', state.targets, 'btc');
        bind('bullEthPrice', state.targets, 'eth');
        bind('bullAdaPrice', state.targets, 'ada');
        bind('bearBuyPrice', state.bear, 'buyPrice');

        $('refresh-btn').addEventListener('click', fetchData);
        $('apply-smart-price').addEventListener('click', () => {
            if (state.ahr.targetPrice > 0) {
                state.bear.buyPrice = parseFloat(state.ahr.targetPrice.toFixed(0));
                $('bearBuyPrice').value = state.bear.buyPrice;
                update();
            }
        });
    }

    function saveState() {
        localStorage.setItem('gemini_sail_v3_3', JSON.stringify({
            holdings: state.holdings,
            targets: state.targets,
            bear: state.bear
        }));
    }

    function loadState() {
        const saved = localStorage.getItem('gemini_sail_v3_3');
        if (saved) {
            const parsed = JSON.parse(saved);
            state.holdings = { ...state.holdings, ...parsed.holdings };
            state.targets = { ...state.targets, ...parsed.targets };
            state.bear = { ...state.bear, ...parsed.bear };
        }
    }

    async function fetchData() {
        const btn = $('refresh-btn');
        btn.classList.add('animate-spin');
        try {
            // 1. Prices
            const resPrice = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,cardano&vs_currencies=usd');
            const dataPrice = await resPrice.json();
            state.prices = { btc: dataPrice.bitcoin.usd, eth: dataPrice.ethereum.usd, ada: dataPrice.cardano.usd };

            // 2. Ahr999 Logic
            const resHist = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=200&interval=daily');
            const dataHist = await resHist.json();
            const prices = dataHist.prices.map(p => p[1]);
            const ma200 = prices.reduce((a, b) => a + b, 0) / prices.length;
            
            const genesisDate = new Date('2009-01-03');
            const today = new Date();
            const daysSinceGenesis = (today - genesisDate) / (1000 * 60 * 60 * 24);
            const fittingPrice = Math.pow(10, (5.84 * Math.log10(daysSinceGenesis) - 17.01));
            
            state.ahr.value = (state.prices.btc / ma200) * (state.prices.btc / fittingPrice);
            state.ahr.targetPrice = Math.sqrt(0.45 * ma200 * fittingPrice);

            renderHeader();
            update();
        } catch (e) {
            console.error(e);
        } finally {
            btn.classList.remove('animate-spin');
        }
    }

    function renderHeader() {
        $('price-btc').textContent = fmt.usd(state.prices.btc);
        $('price-eth').textContent = fmt.usd(state.prices.eth);
        $('price-ada').textContent = fmt.usd(state.prices.ada, 3); // Show 3 decimals for ADA
        $('ahr-value').textContent = state.ahr.value.toFixed(2);
        $('ahr-target-price').textContent = fmt.usd(state.ahr.targetPrice);
    }

    function update() {
        saveState();
        if (!state.prices.btc) return;

        // Calculations
        // 1. Start
        const valStart = {
            btc: state.holdings.btc * state.prices.btc,
            eth: state.holdings.eth * state.prices.eth,
            ada: state.holdings.ada * state.prices.ada
        };
        const totStart = valStart.btc + valStart.eth + valStart.ada;
        
        // 2. Bull
        const valBull = {
            btc: state.holdings.btc * state.targets.btc,
            eth: state.holdings.eth * state.targets.eth,
            ada: state.holdings.ada * state.targets.ada
        };
        const totBull = valBull.btc + valBull.eth + valBull.ada;
        const ammo = valBull.eth + valBull.ada;

        // 3. End
        const newBtc = state.bear.buyPrice ? ammo / state.bear.buyPrice : 0;
        const endTotalBtc = state.holdings.btc + newBtc;
        const endTotalUsd = endTotalBtc * state.bear.buyPrice;
        const multiplier = (state.holdings.eth || state.holdings.ada) ? newBtc / (state.holdings.eth * (state.prices.eth/state.prices.btc) + state.holdings.ada * (state.prices.ada/state.prices.btc)) : 0;

        // Renders
        // Phase 1
        $('start-total-btc').textContent = fmt.btc(state.holdings.btc + (valStart.eth + valStart.ada) / state.prices.btc);
        $('start-total-usd').textContent = fmt.usd(totStart);
        
        const pctStart = { btc: valStart.btc/totStart*100, eth: valStart.eth/totStart*100, ada: valStart.ada/totStart*100 };
        $('bar-start').innerHTML = `
            <div style="width:${pctStart.btc}%" class="bg-btc h-full" title="BTC: ${fmt.pct(pctStart.btc)}"></div>
            <div style="width:${pctStart.eth}%" class="bg-eth h-full" title="ETH: ${fmt.pct(pctStart.eth)}"></div>
            <div style="width:${pctStart.ada}%" class="bg-ada h-full" title="ADA: ${fmt.pct(pctStart.ada)}"></div>
        `;
        $('start-btc-val').textContent = fmt.usd(valStart.btc);
        $('start-eth-val').textContent = fmt.usd(valStart.eth);
        $('start-ada-val').textContent = fmt.usd(valStart.ada);

        // Phase 2
        $('bull-total-btc').textContent = fmt.btc(state.holdings.btc + (valBull.eth + valBull.ada) / state.targets.btc);
        $('bull-total-usd').textContent = fmt.usd(totBull);
        $('harvested-ammo').textContent = fmt.usd(ammo);
        
        const pctBull = { btc: valBull.btc/totBull*100, eth: valBull.eth/totBull*100, ada: valBull.ada/totBull*100 };
        $('bar-bull').innerHTML = `
            <div style="width:${pctBull.btc}%" class="bg-btc h-full opacity-50" title="BTC保留"></div>
            <div style="width:${pctBull.eth}%" class="bg-eth h-full" title="ETH卖出"></div>
            <div style="width:${pctBull.ada}%" class="bg-ada h-full" title="ADA卖出"></div>
        `;
        $('bull-btc-val').textContent = fmt.usd(valBull.btc);
        $('bull-eth-val').textContent = fmt.usd(valBull.eth);
        $('bull-ada-val').textContent = fmt.usd(valBull.ada);

        // Phase 3
        $('end-total-btc').textContent = fmt.btc(endTotalBtc);
        $('end-total-usd').textContent = fmt.usd(endTotalUsd);
        $('sail-multiplier').textContent = multiplier > 0 ? multiplier.toFixed(2) + 'x' : '-';
        
        const pctEnd = { anchor: state.holdings.btc/endTotalBtc*100, sail: newBtc/endTotalBtc*100 };
        $('bar-end').innerHTML = `
            <div style="width:${pctEnd.anchor}%" class="bg-btc h-full" title="原始锚"></div>
            <div style="width:${pctEnd.sail}%" class="bg-usdt h-full" title="新获BTC"></div>
        `;
        
        $('end-anchor-val').textContent = fmt.btc(state.holdings.btc);
        $('end-anchor-detail').textContent = fmt.usd(state.holdings.btc * state.bear.buyPrice);
        $('end-sail-val').textContent = '+' + fmt.btc(newBtc);
        $('end-sail-detail').textContent = fmt.usd(newBtc * state.bear.buyPrice);

        renderChart(state.holdings.btc, (valStart.eth+valStart.ada)/state.prices.btc, newBtc);
    }

    function renderChart(anchor, sailStart, sailEnd) {
        const ctx = $('growthChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        // Chart.js Colors for Light Mode
        const gridColor = '#E5E7EB';
        const tickColor = '#6B7280';

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['起点 (BTC等值)', '终点 (BTC实物)'],
                datasets: [
                    { label: '锚 (BTC)', data: [anchor, anchor], backgroundColor: '#F59E0B', stack: '0' }, // BTC Amber
                    { label: '帆 (山寨/增量)', data: [sailStart, 0], backgroundColor: '#8B5CF6', stack: '0' }, // ETH Purple
                    { label: '新收益', data: [0, sailEnd], backgroundColor: '#10B981', stack: '0' } // USDT Green
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        display: true, 
                        labels: { color: '#374151', font: { family: 'Inter', size: 12 } } 
                    },
                    tooltip: {
                        backgroundColor: 'rgba(17, 24, 39, 0.9)', // Dark tooltip for contrast
                        titleColor: '#F9FAFB',
                        bodyColor: '#D1D5DB',
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: true
                    }
                },
                scales: {
                    x: { 
                        grid: { display: false }, 
                        ticks: { color: tickColor, font: { family: 'Inter' } } 
                    },
                    y: { 
                        grid: { color: gridColor, drawBorder: false }, 
                        ticks: { color: tickColor, font: { family: 'JetBrains Mono' } } 
                    }
                }
            }
        });
    }

    window.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
