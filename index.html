<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>当前周期 “锚与帆” 实战模拟器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712;
            color: #d1d5db;
        }
        .card {
            background-color: #111827;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid #374151;
        }
        .input-group {
            background-color: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #4b5563;
        }
        input[type="number"] {
            background-color: #374151;
            border: 1px solid #6b7280;
            color: #f3f4f6;
        }
        .btn {
            background-color: #2563eb;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #1d4ed8;
        }
        .phase-card {
            background-color: #1f2937;
            padding: 1.25rem;
            border-radius: 0.5rem;
            border-left: 4px solid #3b82f6;
        }
        .summary-card {
             background-color: #1f2937;
            border: 1px solid #f59e0b;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto space-y-8">
        <header class="text-center space-y-2">
            <h1 class="text-3xl md:text-4xl font-bold text-white">当前周期 “锚与帆” 实战模拟器</h1>
            <p class="text-lg text-gray-400">基于您的真实持仓，推演本周期财富增长</p>
        </header>

        <div class="card">
             <h2 class="text-xl font-semibold text-white mb-4">当前周期策略核心</h2>
             <p class="text-sm text-gray-400 leading-relaxed">
                本模拟器基于您的<strong class="text-amber-400">当前实际持仓</strong>进行演算，并严格遵守您为本周期制定的策略：<br>
                <strong class="text-blue-400">⚓ 锚 (核心BTC仓位)</strong>: 您持有的全部BTC，在本轮牛市顶部<strong class="text-amber-400">永不卖出</strong>。<br>
                <strong class="text-green-400">⛵ 帆 (山寨币仓位)</strong>: 您持有的全部山寨币 (ETH, STETH, ADA)，在牛市顶部<strong class="text-amber-400">全部卖出为USDT</strong>，以换取最大化的弹药。
             </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 左侧：参数输入 -->
            <div class="lg:col-span-1 space-y-6">
                <div class="card sticky top-8">
                    <h2 class="text-xl font-semibold text-white mb-4">参数输入</h2>
                    <div class="space-y-4">
                        <div class="input-group">
                            <h3 class="text-sm font-medium text-gray-300 mb-2"><strong>起点:</strong> 当前持仓 (可编辑)</h3>
                            <label for="currentBtc" class="block text-xs mt-2">BTC (锚 ⚓)</label>
                            <input type="number" id="currentBtc" value="0.0871" class="w-full mt-1 p-2 rounded-md">
                            
                            <label for="currentEth" class="block text-xs mt-2">ETH + STETH (帆 ⛵)</label>
                            <input type="number" id="currentEth" value="6.8145" class="w-full mt-1 p-2 rounded-md">
                            
                            <label for="currentAda" class="block text-xs mt-2">ADA (帆 ⛵)</label>
                            <input type="number" id="currentAda" value="24034.3" class="w-full mt-1 p-2 rounded-md">
                        </div>

                        <div class="input-group">
                             <h3 class="text-sm font-medium text-gray-300 mb-2"><strong>历史周期参考:</strong> 上一轮牛顶</h3>
                             <label for="previousBullBtcPrice" class="block text-xs mt-2">2021年 BTC 牛顶价格 (USD)</label>
                             <input type="number" id="previousBullBtcPrice" value="69000" class="w-full mt-1 p-2 rounded-md">
                        </div>

                        <div class="input-group">
                            <h3 class="text-sm font-medium text-gray-300 mb-2"><strong>收获期:</strong> 牛市顶部目标价 (USD)</h3>
                            <label for="bullBtcPrice" class="block text-xs mt-2">BTC 价格</label>
                            <input type="number" id="bullBtcPrice" value="150000" class="w-full mt-1 p-2 rounded-md">
                            <label for="bullEthPrice" class="block text-xs mt-2">ETH / STETH 价格</label>
                            <input type="number" id="bullEthPrice" value="8000" class="w-full mt-1 p-2 rounded-md">
                             <label for="bullAdaPrice" class="block text-xs mt-2">ADA 价格</label>
                            <input type="number" id="bullAdaPrice" value="5" class="w-full mt-1 p-2 rounded-md">
                        </div>

                        <div class="input-group">
                             <h3 class="text-sm font-medium text-gray-300 mb-2"><strong>重新播种:</strong> 下一轮熊底抄底价 (USD)</h3>
                             <label for="bearBtcPrice2" class="block text-xs mt-2">BTC 价格 (默认关联上一轮牛顶)</label>
                             <input type="number" id="bearBtcPrice2" value="69000" class="w-full mt-1 p-2 rounded-md">
                        </div>
                    </div>
                    <button id="runBtn" class="w-full btn text-white font-bold py-3 px-4 rounded-lg text-lg mt-6">
                        🚀 运行本周期模拟
                    </button>
                </div>
            </div>

            <!-- 右侧：模拟结果 -->
            <div class="lg:col-span-2 space-y-6">
                <div class="card">
                    <h2 class="text-xl font-semibold text-white mb-4 text-center">本周期演算流程</h2>
                    <div id="results" class="space-y-6 text-gray-300">
                        <p class="text-center">请在左侧设定牛顶与熊底的目标价，然后点击“运行模拟”。</p>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold text-white mb-4 text-center">BTC总资产增长可视化</h2>
                    <div class="h-64">
                         <canvas id="growthChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    const elements = {
        currentBtc: document.getElementById('currentBtc'),
        currentEth: document.getElementById('currentEth'),
        currentAda: document.getElementById('currentAda'),
        previousBullBtcPrice: document.getElementById('previousBullBtcPrice'),
        bullBtcPrice: document.getElementById('bullBtcPrice'),
        bullEthPrice: document.getElementById('bullEthPrice'),
        bullAdaPrice: document.getElementById('bullAdaPrice'),
        bearBtcPrice2: document.getElementById('bearBtcPrice2'),
        runBtn: document.getElementById('runBtn'),
        results: document.getElementById('results'),
        chartCtx: document.getElementById('growthChart').getContext('2d'),
    };

    let growthChart;
    let currentPrices = {};

    function formatNum(num, decimals = 2) {
        if (typeof num !== 'number' || isNaN(num)) return '...';
        return new Intl.NumberFormat('en-US', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(num);
    }

    async function fetchPricesAndRun() {
        try {
            const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,cardano&vs_currencies=usd');
            if (!response.ok) throw new Error('API request failed');
            const data = await response.json();
            currentPrices = {
                btc: data.bitcoin.usd,
                eth: data.ethereum.usd,
                ada: data.cardano.usd,
            };
        } catch (error) {
            console.error("Price fetch failed:", error);
            elements.results.innerHTML = `<p class="text-center text-red-400">无法获取实时价格，请稍后重试。</p>`;
            return;
        }
        setBearBottomDefault();
        runSimulation();
    }
    
    function runSimulation() {
        // --- 1. 获取输入参数 ---
        const bullBtcPrice = parseFloat(elements.bullBtcPrice.value) || 0;
        const bullEthPrice = parseFloat(elements.bullEthPrice.value) || 0;
        const bullAdaPrice = parseFloat(elements.bullAdaPrice.value) || 0;
        const bearBtcPrice2 = parseFloat(elements.bearBtcPrice2.value) || 0;
        
        // --- 2. 播种期 (当前状态) ---
        const anchorBtc = parseFloat(elements.currentBtc.value) || 0;
        const sailEth = parseFloat(elements.currentEth.value) || 0;
        const sailAda = parseFloat(elements.currentAda.value) || 0;
        
        // --- 2.1 起点可视化计算 ---
        const currentValues = {
            btc: anchorBtc * currentPrices.btc,
            eth: sailEth * currentPrices.eth,
            ada: sailAda * currentPrices.ada,
        };
        const currentTotalValue = currentValues.btc + currentValues.eth + currentValues.ada;
        const currentBtcEquivalents = {
            btc: anchorBtc,
            eth: currentPrices.btc > 0 ? currentValues.eth / currentPrices.btc : 0,
            ada: currentPrices.btc > 0 ? currentValues.ada / currentPrices.btc : 0,
        };
        const currentTotalBtcEq = currentBtcEquivalents.btc + currentBtcEquivalents.eth + currentBtcEquivalents.ada;
        const currentPercentages = {
            btc: currentTotalValue > 0 ? (currentValues.btc / currentTotalValue) * 100 : 0,
            eth: currentTotalValue > 0 ? (currentValues.eth / currentTotalValue) * 100 : 0,
            ada: currentTotalValue > 0 ? (currentValues.ada / currentTotalValue) * 100 : 0,
        };
        
        const startPointHTML = `
            <div class="phase-card">
                <h3 class="font-bold text-lg text-blue-400 mb-2">1. 起点 (当前持仓)</h3>
                 <p class="text-xs text-gray-400 mb-1 mt-2">当前总价值: <strong class="text-white">$${formatNum(currentTotalValue, 0)}</strong> (${formatNum(currentTotalBtcEq, 4)} BTC)</p>
                 <div class="w-full bg-gray-900 h-8 flex text-xs text-white rounded-md overflow-hidden mt-1">
                    <div style="width: ${currentPercentages.btc}%" class="bg-orange-500 flex items-center justify-center">⚓ BTC: ${currentPercentages.btc.toFixed(0)}%</div>
                    <div style="width: ${currentPercentages.eth}%" class="bg-purple-600 flex items-center justify-center">⛵ ETH: ${currentPercentages.eth.toFixed(0)}%</div>
                    <div style="width: ${currentPercentages.ada}%" class="bg-sky-500 flex items-center justify-center">⛵ ADA: ${currentPercentages.ada.toFixed(0)}%</div>
                </div>
                <div class="mt-3 space-y-2 text-xs border-t border-gray-700 pt-3">
                    <div class="grid grid-cols-4 gap-2 text-gray-400 font-semibold">
                        <div>资产</div><div class="text-right">占比</div><div class="text-right">数量/BTC等量</div><div class="text-right">法币价值</div>
                    </div>
                    <div class="grid grid-cols-4 gap-2 items-center"><div class="font-semibold">⚓ BTC</div><div class="text-right">${currentPercentages.btc.toFixed(1)}%</div><div class="text-right font-mono">${formatNum(anchorBtc, 4)} BTC</div><div class="text-right font-mono">$${formatNum(currentValues.btc, 0)}</div></div>
                    <div class="grid grid-cols-4 gap-2 items-center"><div class="font-semibold">⛵ ETH</div><div class="text-right">${currentPercentages.eth.toFixed(1)}%</div><div class="text-right font-mono">${formatNum(currentBtcEquivalents.eth, 4)} BTC</div><div class="text-right font-mono">$${formatNum(currentValues.eth, 0)}</div></div>
                    <div class="grid grid-cols-4 gap-2 items-center"><div class="font-semibold">⛵ ADA</div><div class="text-right">${currentPercentages.ada.toFixed(1)}%</div><div class="text-right font-mono">${formatNum(currentBtcEquivalents.ada, 4)} BTC</div><div class="text-right font-mono">$${formatNum(currentValues.ada, 0)}</div></div>
                </div>
            </div>`;

        // --- 3. 收获期 (牛市顶部) ---
        const anchorValueBull = anchorBtc * bullBtcPrice;
        const sailEthValueBull = sailEth * bullEthPrice;
        const sailAdaValueBull = sailAda * bullAdaPrice;
        const totalValueBull = anchorValueBull + sailEthValueBull + sailAdaValueBull;
        const harvestedUsdt = sailEthValueBull + sailAdaValueBull;
        const anchorPctBull = totalValueBull > 0 ? (anchorValueBull / totalValueBull) * 100 : 0;
        const sailEthPctBull = totalValueBull > 0 ? (sailEthValueBull / totalValueBull) * 100 : 0;
        const sailAdaPctBull = totalValueBull > 0 ? (sailAdaValueBull / totalValueBull) * 100 : 0;
        const anchorBtcEqBull = anchorBtc;
        const sailEthBtcEqBull = bullBtcPrice > 0 ? sailEthValueBull / bullBtcPrice : 0;
        const sailAdaBtcEqBull = bullBtcPrice > 0 ? sailAdaValueBull / bullBtcPrice : 0;

        // --- 4. 重新播种 (下一轮熊市底部) ---
        const newBtcFromSail = bearBtcPrice2 > 0 ? harvestedUsdt / bearBtcPrice2 : 0;
        const finalTotalBtc = anchorBtc + newBtcFromSail;
        const anchorFinalPct = finalTotalBtc > 0 ? (anchorBtc / finalTotalBtc * 100) : 0;
        const newSailFinalPct = finalTotalBtc > 0 ? (newBtcFromSail / finalTotalBtc * 100) : 0;
        
        // --- 5. 渲染结果 ---
        elements.results.innerHTML = `
            ${startPointHTML}
            <div class="text-center text-gray-500 text-2xl">↓</div>

            <div class="phase-card border-l-red-500">
                <h3 class="font-bold text-lg text-red-400 mb-2">2. 收获期 (牛市顶部)</h3>
                <p class="text-xs text-gray-400 mb-1 mt-2">牛顶总价值: <strong class="text-white">$${formatNum(totalValueBull, 0)}</strong> (${formatNum(anchorBtc + sailEthBtcEqBull + sailAdaBtcEqBull, 4)} BTC)</p>
                <div class="w-full bg-gray-900 h-8 flex text-xs text-white rounded-md overflow-hidden mt-1">
                    <div style="width: ${anchorPctBull}%" class="bg-orange-500 flex items-center justify-center">⚓ 锚 (BTC): ${formatNum(anchorPctBull, 0)}%</div>
                    <div style="width: ${sailEthPctBull}%" class="bg-purple-600 flex items-center justify-center">⛵ 帆 (ETH): ${formatNum(sailEthPctBull, 0)}%</div>
                    <div style="width: ${sailAdaPctBull}%" class="bg-sky-500 flex items-center justify-center">⛵ 帆 (ADA): ${formatNum(sailAdaPctBull, 0)}%</div>
                </div>
                 <div class="mt-3 space-y-2 text-xs border-t border-gray-700 pt-3">
                    <div class="grid grid-cols-4 gap-2 text-gray-400 font-semibold">
                        <div>资产</div><div class="text-right">占比</div><div class="text-right">BTC等量</div><div class="text-right">法币价值</div>
                    </div>
                    <div class="grid grid-cols-4 gap-2 items-center"><div class="font-semibold">⚓ 锚(BTC)</div><div class="text-right">${anchorPctBull.toFixed(1)}%</div><div class="text-right font-mono">${formatNum(anchorBtcEqBull, 4)} BTC</div><div class="text-right font-mono">$${formatNum(anchorValueBull, 0)}</div></div>
                    <div class="grid grid-cols-4 gap-2 items-center"><div class="font-semibold">⛵ 帆(ETH)</div><div class="text-right">${sailEthPctBull.toFixed(1)}%</div><div class="text-right font-mono">${formatNum(sailEthBtcEqBull, 4)} BTC</div><div class="text-right font-mono">$${formatNum(sailEthValueBull, 0)}</div></div>
                    <div class="grid grid-cols-4 gap-2 items-center"><div class="font-semibold">⛵ 帆(ADA)</div><div class="text-right">${sailAdaPctBull.toFixed(1)}%</div><div class="text-right font-mono">${formatNum(sailAdaBtcEqBull, 4)} BTC</div><div class="text-right font-mono">$${formatNum(sailAdaValueBull, 0)}</div></div>
                </div>
                <p class="mt-4 text-sm">➡️ 严格执行纪律: <strong class="text-amber-400">“锚”仓位不动</strong>, <strong class="text-amber-400">“帆”仓位(ETH/ADA)全部卖出</strong></p>
                <p class="font-semibold text-yellow-300">💰 收获弹药: ${formatNum(harvestedUsdt, 0)} USDT</p>
            </div>

            <div class="text-center text-gray-500 text-2xl">↓</div>

            <div class="phase-card border-l-yellow-500">
                <h3 class="font-bold text-lg text-yellow-400 mb-2">3. 重新播种 (下一轮熊底)</h3>
                <p class="text-sm">➡️ 将全部 ${formatNum(harvestedUsdt, 0)} USDT 弹药, 在 BTC=$${formatNum(bearBtcPrice2, 0)} 时买入BTC</p>
                <p class="font-semibold text-green-300">⛵ “帆”带回: ${formatNum(newBtcFromSail, 4)} BTC</p>
                <div class="mt-3">
                    <p class="text-xs text-gray-400 mb-1 mt-2">熊底总仓位构成 (总价值: <strong class="text-white">$${formatNum(finalTotalBtc * bearBtcPrice2, 0)}</strong> | 总BTC量: <strong class="text-white">${formatNum(finalTotalBtc, 4)} BTC</strong>)</p>
                    <div class="w-full bg-gray-900 h-8 flex text-xs text-white rounded-md overflow-hidden mt-1">
                        <div style="width: ${anchorFinalPct}%" class="bg-orange-500 flex items-center justify-center">⚓ 锚: ${anchorFinalPct.toFixed(0)}%</div>
                        <div style="width: ${newSailFinalPct}%" class="bg-green-500 flex items-center justify-center">⛵ 帆(新): ${newSailFinalPct.toFixed(0)}%</div>
                   </div>
                   <div class="mt-3 space-y-2 text-xs border-t border-gray-700 pt-3">
                    <div class="grid grid-cols-4 gap-2 text-gray-400 font-semibold">
                        <div>资产构成</div><div class="text-right">占比</div><div class="text-right">BTC数量</div><div class="text-right">法币价值</div>
                    </div>
                    <div class="grid grid-cols-4 gap-2 items-center"><div class="font-semibold">⚓ 锚(原始)</div><div class="text-right">${anchorFinalPct.toFixed(1)}%</div><div class="text-right font-mono">${formatNum(anchorBtc, 4)} BTC</div><div class="text-right font-mono">$${formatNum(anchorBtc * bearBtcPrice2, 0)}</div></div>
                    <div class="grid grid-cols-4 gap-2 items-center"><div class="font-semibold">⛵ 帆(新获)</div><div class="text-right">${newSailFinalPct.toFixed(1)}%</div><div class="text-right font-mono">${formatNum(newBtcFromSail, 4)} BTC</div><div class="text-right font-mono">$${formatNum(newBtcFromSail * bearBtcPrice2, 0)}</div></div>
                   </div>
                </div>
            </div>
            
            <hr class="border-gray-600 my-4">

            <div class="summary-card p-4 rounded-lg">
                <h3 class="font-bold text-xl text-amber-400 mb-3 text-center">🏆 本周期总结与下一轮起点 🏆</h3>
                <div class="space-y-3 text-center">
                    <p><strong>本周期“锚”仓位 (未动):</strong> ${formatNum(anchorBtc, 4)} BTC</p>
                    <p><strong>本周期“帆”带回仓位:</strong> ${formatNum(newBtcFromSail, 4)} BTC</p>
                    <p class="text-2xl font-bold text-white"><strong>下一周期起点总资产: ${formatNum(finalTotalBtc, 4)} BTC</strong></p>
                    <p class="pt-3 text-sm">下一轮远航，您可以将这 ${formatNum(finalTotalBtc, 4)} BTC 作为起点, 再次按 50/50 分配给新的“锚”与“帆”。</p>
                </div>
            </div>
        `;

        const initialSailBtcEq = currentBtcEquivalents.eth + currentBtcEquivalents.ada;
        renderChart({
            anchor: anchorBtc,
            initialSail: initialSailBtcEq,
            newSail: newBtcFromSail
        });
    }

    function renderChart(data) {
        if (growthChart) {
            growthChart.destroy();
        }
        growthChart = new Chart(elements.chartCtx, {
            type: 'bar',
            data: {
                labels: ['周期起点总BTC', '下一周期总BTC'],
                datasets: [
                    {
                        label: '锚 ⚓ (核心仓位)',
                        data: [data.anchor, data.anchor],
                        backgroundColor: '#ea580c',
                        borderColor: '#c2410c',
                        borderWidth: 1,
                        stack: 'Stack 0',
                    },
                     {
                        label: '帆 ⛵ (周期变化)',
                        data: [data.initialSail, data.newSail],
                        backgroundColor: '#16a34a',
                        borderColor: '#15803d',
                        borderWidth: 1,
                        stack: 'Stack 0',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: '#d1d5db' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += formatNum(context.parsed.y, 4) + ' BTC';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#d1d5db' },
                        grid: { color: '#374151' }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: { color: '#d1d5db' },
                        grid: { color: '#374151' },
                        title: {
                            display: true,
                            text: 'BTC 数量',
                            color: '#d1d5db'
                        }
                    }
                }
            }
        });
    }

    function setBearBottomDefault() {
        elements.bearBtcPrice2.value = elements.previousBullBtcPrice.value;
    }
    
    elements.previousBullBtcPrice.addEventListener('input', setBearBottomDefault);
    elements.runBtn.addEventListener('click', runSimulation);
    window.addEventListener('load', fetchPricesAndRun);

</script>
</body>
</html>

