<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Èîö‰∏éÂ∏Ü | ÊàòÁï•ÊåáÊå•Ëà± v3.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ÂºïÂÖ• Google Fonts Âíå Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        btc: '#F7931A',
                        eth: '#627EEA',
                        ada: '#3CC8C8', // ‰øÆÊîπ‰∏∫‰∫ÆÈùíËâ≤ÔºåÂú®ÈªëËâ≤ËÉåÊôØ‰∏ãÊõ¥Ê∏ÖÊô∞
                        usdt: '#26A17B',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        success: '#10B981',
                        dark: {
                            900: '#050505',
                            800: '#0A0A0A',
                            700: '#121212',
                            600: '#1E1E1E',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050505;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(60, 200, 200, 0.05) 0%, transparent 20%), /* ADA color hint */
                radial-gradient(circle at 90% 80%, rgba(247, 147, 26, 0.05) 0%, transparent 20%);
            color: #e5e7eb;
        }
        .glass-panel {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .input-field {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }
        .input-field:focus {
            border-color: #F7931A;
            box-shadow: 0 0 0 2px rgba(247, 147, 26, 0.15);
            outline: none;
        }
        .progress-segment {
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* ÊªöÂä®Êù°ÁæéÂåñ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6 text-sm">

    <div class="max-w-[1600px] mx-auto space-y-6">
        
        <!-- Header: ÂÆûÊó∂Ë°åÊÉÖ‰∏é Ahr999 -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 pb-6 border-b border-white/5">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-btc to-orange-700 flex items-center justify-center shadow-lg shadow-orange-900/20">
                        <i class="ph-fill ph-anchor text-white text-xl"></i>
                    </div>
                    <div>
                        <span class="bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">Èîö‰∏éÂ∏Ü</span>
                        <span class="text-gray-600 text-base font-normal ml-2 hidden md:inline">| ÊàòÁï•ÊåáÊå•Ëà± v3.1</span>
                    </div>
                </h1>
            </div>
            
            <!-- Ahr999 ÂÆûÊó∂Èõ∑Ëææ -->
            <div class="flex gap-4 items-stretch">
                <div class="glass-panel px-4 py-2 rounded-lg flex flex-col justify-center min-w-[180px]">
                    <div class="text-[10px] text-gray-400 uppercase tracking-wider flex justify-between">
                        <span>Ahr999 Index</span>
                        <span id="ahr-status-text" class="font-bold text-gray-500">--</span>
                    </div>
                    <div class="flex items-baseline gap-2 mt-1">
                        <span id="ahr-value" class="text-2xl font-mono font-bold text-white">--.--</span>
                        <div class="h-2 w-16 bg-gray-700 rounded-full overflow-hidden relative">
                            <div id="ahr-bar" class="h-full w-0 bg-gray-500 transition-all duration-500"></div>
                        </div>
                    </div>
                </div>

                <div id="price-ticker" class="glass-panel px-4 py-2 rounded-lg flex items-center gap-4 font-mono text-xs md:text-sm">
                    <div class="flex flex-col">
                        <span class="text-gray-500 text-[10px]">BTC Price</span>
                        <span class="text-btc font-bold text-lg" id="price-btc">$--</span>
                    </div>
                    <div class="w-px h-8 bg-white/10"></div>
                    <div class="flex flex-col">
                        <span class="text-gray-500 text-[10px]">ETH Price</span>
                        <span class="text-eth font-bold" id="price-eth">$--</span>
                    </div>
                    <div class="w-px h-8 bg-white/10"></div>
                    <div class="flex flex-col">
                        <span class="text-gray-500 text-[10px]">ADA Price</span>
                        <span class="text-ada font-bold" id="price-ada">$--</span>
                    </div>
                </div>
                
                <button id="refresh-btn" class="glass-panel px-3 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white transition-colors">
                    <i class="ph-bold ph-arrows-clockwise text-xl"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
            
            <!-- Â∑¶‰æßÔºöÊéßÂà∂‰∏≠ÂøÉ (3Âàó) -->
            <div class="xl:col-span-3 space-y-5">
                
                <!-- 1. ËµÑ‰∫ßÈÖçÁΩÆ -->
                <div class="glass-panel rounded-xl p-5">
                    <h2 class="text-white font-semibold mb-4 flex items-center gap-2 text-sm">
                        <i class="ph-duotone ph-wallet text-blue-400"></i> 1. ÂΩìÂâçÊåÅ‰ªì (Ëµ∑ÁÇπ)
                    </h2>
                    <div class="space-y-4">
                        <div class="bg-dark-800/50 p-3 rounded-lg border border-white/5">
                            <label class="flex justify-between text-[10px] text-gray-400 mb-1 uppercase tracking-wider">
                                <span>‚öì Ê†∏ÂøÉÈîö (BTC)</span>
                                <span class="text-btc/80"><i class="ph-fill ph-lock-key"></i> ÈîÅÂÆö</span>
                            </label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="currentBtc" class="input-field flex-1 p-2 rounded text-white font-mono text-sm bg-transparent border-0 border-b border-gray-700 focus:border-btc px-0 focus:ring-0" placeholder="0.00">
                                <span class="text-xs text-gray-500 font-mono">BTC</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-dark-800/50 p-3 rounded-lg border border-white/5">
                                <label class="block text-[10px] text-gray-400 mb-1 uppercase">‚õµ ETH+STETH</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="currentEth" class="input-field flex-1 p-2 rounded text-white font-mono text-sm bg-transparent border-0 border-b border-gray-700 focus:border-eth px-0 focus:ring-0">
                                </div>
                            </div>
                            <div class="bg-dark-800/50 p-3 rounded-lg border border-white/5">
                                <label class="block text-[10px] text-gray-400 mb-1 uppercase">‚õµ ADA</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="currentAda" class="input-field flex-1 p-2 rounded text-white font-mono text-sm bg-transparent border-0 border-b border-gray-700 focus:border-ada px-0 focus:ring-0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. ÁâõÈ°∂È¢ÑÊµã -->
                <div class="glass-panel rounded-xl p-5 relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-red-500 to-orange-600 opacity-50 group-hover:opacity-100 transition-opacity"></div>
                    <h2 class="text-white font-semibold mb-4 flex items-center gap-2 text-sm">
                        <i class="ph-duotone ph-trend-up text-red-400"></i> 2. ÁâõÈ°∂ÁõÆÊ†á (Êî∂Ëé∑Êúü)
                    </h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-[10px] text-gray-400 mb-1">BTC ÁõÆÊ†á‰ª∑ ($)</label>
                            <input type="number" id="bullBtcPrice" class="input-field w-full p-2.5 rounded-lg text-white font-mono font-bold border-l-2 border-l-btc" value="150000">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-[10px] text-gray-400 mb-1">ETH ÁõÆÊ†á‰ª∑ ($)</label>
                                <input type="number" id="bullEthPrice" class="input-field w-full p-2 rounded-lg text-gray-300 font-mono text-xs" value="8000">
                            </div>
                            <div>
                                <label class="block text-[10px] text-gray-400 mb-1">ADA ÁõÆÊ†á‰ª∑ ($)</label>
                                <input type="number" id="bullAdaPrice" class="input-field w-full p-2 rounded-lg text-gray-300 font-mono text-xs" value="5">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. ÁÜäÂ∫ïÊäÑÂ∫ï (Êô∫ËÉΩÁâà) -->
                <div class="glass-panel rounded-xl p-5 relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-usdt to-emerald-600 opacity-50 group-hover:opacity-100 transition-opacity"></div>
                    <h2 class="text-white font-semibold mb-4 flex items-center gap-2 text-sm">
                        <i class="ph-duotone ph-magnet text-usdt"></i> 3. ÁÜäÂ∫ïÊäÑÂ∫ï (All-in)
                    </h2>
                    
                    <!-- Êô∫ËÉΩÂª∫ËÆÆÂç°Áâá -->
                    <div class="mb-4 p-3 bg-emerald-900/20 border border-emerald-500/20 rounded-lg">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] text-emerald-400 font-semibold">üß† Ahr999 Êô∫ËÉΩÈ¢ÑÊµã</span>
                            <i class="ph-fill ph-magic-wand text-emerald-400 text-xs"></i>
                        </div>
                        <p class="text-[10px] text-gray-400 leading-relaxed">
                            Âü∫‰∫éÂΩìÂâç 200Êó•ÂùáÁ∫øÔºåAhr999 Ë∑åËá≥ <span class="text-white font-bold">0.45</span> (All-in Á∫ø) ÁöÑÁêÜËÆ∫‰ª∑Ê†º‰∏∫Ôºö
                        </p>
                        <div class="mt-1 flex items-center justify-between">
                            <span id="ahr-target-price" class="text-lg font-mono font-bold text-white">Computing...</span>
                            <button id="apply-smart-price" class="text-[10px] bg-emerald-600 hover:bg-emerald-500 text-white px-2 py-1 rounded transition-colors">
                                Â∫îÁî®Ê≠§‰ª∑Ê†º
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-[10px] text-gray-400 mb-1">ÊÇ®ÁöÑÊäÑÂ∫ïÊåÇÂçï‰ª∑ ($)</label>
                        <input type="number" id="bearBuyPrice" class="input-field w-full p-2.5 rounded-lg text-white font-mono text-lg font-bold border-l-2 border-l-usdt">
                    </div>
                </div>

            </div>

            <!-- Âè≥‰æßÔºöÂÖ®ÊôØÊé®Êºî (9Âàó) -->
            <div class="xl:col-span-9 space-y-6">
                
                <!-- Èò∂ÊÆµÊé®ÊºîÊµÅ -->
                <div class="grid grid-cols-1 gap-4">
                    
                    <!-- Phase 1: Ëµ∑ÁÇπ -->
                    <div class="glass-panel p-5 rounded-xl border-t-2 border-t-blue-500 relative">
                        <div class="absolute -top-3 left-4 bg-dark-900 px-2 text-blue-400 text-xs font-bold uppercase tracking-widest border border-blue-500/30 rounded">Phase 1: ÂΩìÂâç</div>
                        <div class="flex flex-wrap justify-between items-end gap-4 mb-4">
                            <div>
                                <div class="text-3xl font-mono font-bold text-white tracking-tight" id="start-total-btc">-- BTC</div>
                                <div class="text-xs text-gray-500 font-mono mt-1" id="start-total-usd">$ --</div>
                            </div>
                            <!-- ÁÆÄÂåñËøõÂ∫¶Êù° -->
                            <div class="flex-1 min-w-[200px] max-w-md">
                                <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                                    <span>ËµÑ‰∫ßÊûÑÊàê</span>
                                    <span id="start-btc-pct">--% BTC</span>
                                </div>
                                <div class="h-2 w-full bg-gray-800 rounded-full overflow-hidden flex" id="bar-start"></div>
                            </div>
                        </div>
                        <!-- ËØ¶ÁªÜÊï∞ÊçÆË°® -->
                        <div class="grid grid-cols-3 gap-4 border-t border-white/5 pt-4">
                            <div class="text-center border-r border-white/5">
                                <div class="text-[10px] text-gray-500 uppercase">‚öì BTC (Èîö)</div>
                                <div class="font-mono text-sm text-btc" id="start-val-btc">--</div>
                                <div class="text-[10px] text-gray-600" id="start-qty-btc">--</div>
                            </div>
                            <div class="text-center border-r border-white/5">
                                <div class="text-[10px] text-gray-500 uppercase">‚õµ ETH (Â∏Ü)</div>
                                <div class="font-mono text-sm text-eth" id="start-val-eth">--</div>
                                <div class="text-[10px] text-gray-600" id="start-qty-eth">--</div>
                            </div>
                            <div class="text-center">
                                <div class="text-[10px] text-gray-500 uppercase">‚õµ ADA (Â∏Ü)</div>
                                <div class="font-mono text-sm text-ada" id="start-val-ada">--</div>
                                <div class="text-[10px] text-gray-600" id="start-qty-ada">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- ÁÆ≠Â§¥ËøûÊé• -->
                    <div class="flex justify-center -my-2 z-10 opacity-50">
                        <i class="ph-fill ph-arrow-fat-down text-gray-700 text-2xl"></i>
                    </div>

                    <!-- Phase 2: ÁâõÈ°∂ -->
                    <div class="glass-panel p-5 rounded-xl border-t-2 border-t-red-500 relative">
                        <div class="absolute -top-3 left-4 bg-dark-900 px-2 text-red-400 text-xs font-bold uppercase tracking-widest border border-red-500/30 rounded">Phase 2: ÁâõÈ°∂Êî∂Ââ≤</div>
                        
                        <div class="flex flex-wrap justify-between items-end gap-4 mb-4">
                            <div>
                                <div class="text-3xl font-mono font-bold text-white tracking-tight" id="bull-total-btc">-- BTC</div>
                                <div class="text-xs text-gray-500 font-mono mt-1">Â≥∞ÂÄº‰ª∑ÂÄº: <span id="bull-total-usd" class="text-white">$--</span></div>
                            </div>
                            <div class="flex-1 min-w-[200px] max-w-md text-right">
                                <div class="inline-block bg-usdt/10 border border-usdt/30 rounded-lg px-4 py-2">
                                    <div class="text-[10px] text-usdt uppercase font-bold mb-0.5">üí∞ Êî∂Ëé∑ÂºπËçØ (USDT)</div>
                                    <div class="text-xl font-mono font-bold text-white" id="harvested-ammo">$--</div>
                                </div>
                            </div>
                        </div>

                        <!-- ËøõÂ∫¶Êù° -->
                        <div class="h-2 w-full bg-gray-800 rounded-full overflow-hidden flex mb-4" id="bar-bull"></div>

                        <!-- ËØ¶ÁªÜÊï∞ÊçÆË°® -->
                        <div class="grid grid-cols-3 gap-4 border-t border-white/5 pt-4">
                            <div class="text-center border-r border-white/5 opacity-50">
                                <div class="text-[10px] text-gray-500 uppercase">‚öì BTC (‰øùÁïô)</div>
                                <div class="font-mono text-sm text-white" id="bull-val-btc">--</div>
                                <div class="text-[10px] text-gray-600" id="bull-qty-btc">--</div>
                            </div>
                            <div class="text-center border-r border-white/5">
                                <div class="text-[10px] text-gray-500 uppercase">‚õµ ETH (ÂçñÂá∫)</div>
                                <div class="font-mono text-sm text-red-400" id="bull-val-eth">--</div>
                                <div class="text-[10px] text-gray-600" id="bull-qty-eth">--</div>
                            </div>
                            <div class="text-center">
                                <div class="text-[10px] text-gray-500 uppercase">‚õµ ADA (ÂçñÂá∫)</div>
                                <div class="font-mono text-sm text-red-400" id="bull-val-ada">--</div>
                                <div class="text-[10px] text-gray-600" id="bull-qty-ada">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- ÁÆ≠Â§¥ËøûÊé• -->
                    <div class="flex justify-center -my-2 z-10 opacity-50">
                        <i class="ph-fill ph-arrow-fat-down text-gray-700 text-2xl"></i>
                    </div>

                    <!-- Phase 3: ÁÜäÂ∫ï -->
                    <div class="glass-panel p-5 rounded-xl border-t-2 border-t-usdt relative bg-gradient-to-b from-usdt/5 to-transparent">
                        <div class="absolute -top-3 left-4 bg-dark-900 px-2 text-usdt text-xs font-bold uppercase tracking-widest border border-usdt/30 rounded">Phase 3: ÊúÄÁªàÊàêÊûú</div>
                        
                        <div class="flex flex-wrap justify-between items-end gap-4 mb-4">
                            <div>
                                <div class="text-4xl font-mono font-bold text-btc tracking-tight" id="end-total-btc">-- BTC</div>
                                <div class="text-xs text-gray-500 font-mono mt-1">ÁÜäÂ∫ïÊÄª‰ª∑ÂÄº: <span id="end-total-usd" class="text-gray-300">$--</span></div>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] text-gray-500 uppercase">Â∏Ü‰ªì‰ΩçÂÄçÊï∞</div>
                                <div class="text-2xl font-mono font-bold text-white" id="sail-multiplier">0.0x</div>
                            </div>
                        </div>

                        <!-- ËøõÂ∫¶Êù° -->
                        <div class="h-3 w-full bg-gray-800 rounded-full overflow-hidden flex mb-4" id="bar-end"></div>

                        <!-- ËØ¶ÁªÜÊï∞ÊçÆË°® -->
                        <div class="grid grid-cols-2 gap-4 border-t border-white/5 pt-4">
                            <div class="flex justify-between items-center px-4 py-2 rounded bg-dark-800/50 border border-white/5">
                                <div>
                                    <div class="text-[10px] text-gray-500 uppercase">‚öì ÂéüÂßãÈîö‰ªì‰Ωç</div>
                                    <div class="font-mono text-sm text-btc" id="end-anchor-qty">--</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-[10px] text-gray-600" id="end-anchor-pct">--%</div>
                                    <div class="text-[10px] text-gray-600 font-mono" id="end-anchor-val">--</div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center px-4 py-2 rounded bg-usdt/10 border border-usdt/20">
                                <div>
                                    <div class="text-[10px] text-usdt uppercase">‚õµ Â∏ÜÂ∏¶ÂõûÊñ∞BTC</div>
                                    <div class="font-mono text-sm text-white font-bold" id="end-sail-qty">--</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-[10px] text-usdt/70" id="end-sail-pct">--%</div>
                                    <div class="text-[10px] text-usdt/70 font-mono" id="end-sail-val">--</div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- ÁªàÊûÅÂõæË°® -->
                <div class="glass-panel rounded-xl p-6">
                    <div class="h-64 w-full">
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>

            </div>
        </div>
    </div>

<script>
    // --- State Management ---
    const state = {
        holdings: { btc: 0.0871, eth: 4.5603, ada: 45029.7432 },
        prices: { btc: 0, eth: 0, ada: 0 },
        targets: { btc: 150000, eth: 8000, ada: 5 },
        bear: { buyPrice: 69000 },
        ahr: { value: 0, status: 'Loading', ma200: 0, fitting: 0, targetPrice: 0 }
    };

    // --- DOM Elements ---
    const $ = (id) => document.getElementById(id);
    
    // --- Global Variables ---
    let chartInstance = null;

    // --- Utils ---
    const fmt = {
        usd: (n, d=0) => '$' + new Intl.NumberFormat('en-US', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n),
        btc: n => new Intl.NumberFormat('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 4 }).format(n) + ' BTC',
        pct: n => n.toFixed(1) + '%',
        num: (n, d=2) => new Intl.NumberFormat('en-US', { maximumFractionDigits: d }).format(n)
    };

    // --- Logic ---

    function init() {
        loadState();
        bindEvents();
        fetchData();
    }

    function bindEvents() {
        // Input binding helper
        const bind = (id, obj, key) => {
            const el = $(id);
            if(el) {
                el.value = obj[key];
                el.addEventListener('input', (e) => { 
                    obj[key] = parseFloat(e.target.value) || 0; 
                    update(); 
                });
            }
        };

        bind('currentBtc', state.holdings, 'btc');
        bind('currentEth', state.holdings, 'eth');
        bind('currentAda', state.holdings, 'ada');
        bind('bullBtcPrice', state.targets, 'btc');
        bind('bullEthPrice', state.targets, 'eth');
        bind('bullAdaPrice', state.targets, 'ada');
        bind('bearBuyPrice', state.bear, 'buyPrice');

        $('refresh-btn').addEventListener('click', fetchData);
        $('apply-smart-price').addEventListener('click', () => {
            if (state.ahr.targetPrice > 0) {
                state.bear.buyPrice = parseFloat(state.ahr.targetPrice.toFixed(0));
                $('bearBuyPrice').value = state.bear.buyPrice;
                update();
            }
        });
    }

    function saveState() {
        localStorage.setItem('gemini_sail_v3_1', JSON.stringify({
            holdings: state.holdings,
            targets: state.targets,
            bear: state.bear
        }));
    }

    function loadState() {
        const saved = localStorage.getItem('gemini_sail_v3_1');
        if (saved) {
            const parsed = JSON.parse(saved);
            state.holdings = { ...state.holdings, ...parsed.holdings };
            state.targets = { ...state.targets, ...parsed.targets };
            state.bear = { ...state.bear, ...parsed.bear };
        }
    }

    async function fetchData() {
        const btn = $('refresh-btn');
        btn.classList.add('animate-spin');
        try {
            // 1. Current Prices
            const resPrice = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,cardano&vs_currencies=usd');
            const dataPrice = await resPrice.json();
            state.prices = {
                btc: dataPrice.bitcoin.usd,
                eth: dataPrice.ethereum.usd,
                ada: dataPrice.cardano.usd
            };

            // 2. Historical Data for 200MA
            // Fetch last 200 days
            const resHist = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=200&interval=daily');
            const dataHist = await resHist.json();
            const prices = dataHist.prices.map(p => p[1]);
            
            // Calculate 200MA
            const ma200 = prices.reduce((a, b) => a + b, 0) / prices.length;
            state.ahr.ma200 = ma200;

            // Calculate Ahr999
            // Formula: AHR999 = (Price / 200MA) * (Price / FittingPrice)
            // Fitting Price = 10^(5.84 * log10(days) - 17.01)
            const genesisDate = new Date('2009-01-03');
            const today = new Date();
            const daysSinceGenesis = (today - genesisDate) / (1000 * 60 * 60 * 24);
            
            const fittingPrice = Math.pow(10, (5.84 * Math.log10(daysSinceGenesis) - 17.01));
            state.ahr.fitting = fittingPrice;

            const ahrValue = (state.prices.btc / ma200) * (state.prices.btc / fittingPrice);
            state.ahr.value = ahrValue;

            // Calculate Target Price for Ahr999 = 0.45 (All-in)
            state.ahr.targetPrice = Math.sqrt(0.45 * ma200 * fittingPrice);

            updateTicker();
            updateAhrWidget();
            update();

        } catch (e) {
            console.error("Data fetch failed", e);
            $('price-ticker').innerHTML = `<span class="text-red-400">Êï∞ÊçÆËé∑ÂèñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï</span>`;
        } finally {
            btn.classList.remove('animate-spin');
        }
    }

    function updateTicker() {
        $('price-btc').textContent = fmt.usd(state.prices.btc, 0);
        $('price-eth').textContent = fmt.usd(state.prices.eth, 0);
        $('price-ada').textContent = fmt.usd(state.prices.ada, 3);
    }

    function updateAhrWidget() {
        const val = state.ahr.value;
        const elVal = $('ahr-value');
        const elText = $('ahr-status-text');
        const elBar = $('ahr-bar');
        const elTarget = $('ahr-target-price');

        elVal.textContent = val.toFixed(2);
        elTarget.textContent = fmt.usd(state.ahr.targetPrice);

        let status = '', color = '';
        let width = 0;

        if (val <= 0.45) {
            status = 'ALL IN ZONE'; color = 'bg-red-500'; width = '20%';
            elVal.className = "text-3xl font-mono font-bold text-red-500 animate-pulse";
        } else if (val <= 1.2) {
            status = 'DCA ZONE'; color = 'bg-green-500'; width = '50%';
            elVal.className = "text-2xl font-mono font-bold text-green-400";
        } else {
            status = 'HIGH RISK'; color = 'bg-orange-500'; width = '90%';
            elVal.className = "text-2xl font-mono font-bold text-orange-400";
        }

        elText.textContent = status;
        elText.className = `font-bold text-[10px] tracking-widest ${val <= 0.45 ? 'text-red-400' : val <= 1.2 ? 'text-green-400' : 'text-orange-400'}`;
        elBar.className = `h-full ${color} transition-all duration-500`;
        elBar.style.width = width;
    }

    function calculate() {
        // 1. Start
        const valStart = {
            btc: state.holdings.btc * state.prices.btc,
            eth: state.holdings.eth * state.prices.eth,
            ada: state.holdings.ada * state.prices.ada
        };
        const totalValStart = valStart.btc + valStart.eth + valStart.ada;
        
        const btcEqStart = {
            btc: state.holdings.btc,
            eth: state.prices.btc ? valStart.eth / state.prices.btc : 0,
            ada: state.prices.btc ? valStart.ada / state.prices.btc : 0
        };
        const totalBtcEqStart = btcEqStart.btc + btcEqStart.eth + btcEqStart.ada;

        const pctStart = {
            btc: totalValStart ? (valStart.btc / totalValStart) * 100 : 0,
            eth: totalValStart ? (valStart.eth / totalValStart) * 100 : 0,
            ada: totalValStart ? (valStart.ada / totalValStart) * 100 : 0
        };

        // 2. Bull
        const valBull = {
            btc: state.holdings.btc * state.targets.btc,
            eth: state.holdings.eth * state.targets.eth,
            ada: state.holdings.ada * state.targets.ada
        };
        const totalValBull = valBull.btc + valBull.eth + valBull.ada;
        const ammo = valBull.eth + valBull.ada; // Sail sold

        const btcEqBull = {
            btc: state.holdings.btc,
            eth: state.targets.btc ? valBull.eth / state.targets.btc : 0,
            ada: state.targets.btc ? valBull.ada / state.targets.btc : 0
        };
        const totalBtcEqBull = btcEqBull.btc + btcEqBull.eth + btcEqBull.ada;

        const pctBull = {
            btc: totalValBull ? (valBull.btc / totalValBull) * 100 : 0,
            eth: totalValBull ? (valBull.eth / totalValBull) * 100 : 0,
            ada: totalValBull ? (valBull.ada / totalValBull) * 100 : 0
        };

        // 3. Bear (End)
        const newBtc = state.bear.buyPrice ? ammo / state.bear.buyPrice : 0;
        const finalBtc = state.holdings.btc + newBtc;
        const finalVal = finalBtc * state.bear.buyPrice; 

        const pctEnd = {
            anchor: finalBtc ? (state.holdings.btc / finalBtc) * 100 : 0,
            sail: finalBtc ? (newBtc / finalBtc) * 100 : 0
        };
        
        const multiplier = (state.holdings.eth > 0 || state.holdings.ada > 0) 
            ? newBtc / (btcEqStart.eth + btcEqStart.ada) 
            : 0;

        return {
            start: { val: valStart, btcEq: btcEqStart, pct: pctStart, totalVal: totalValStart, totalBtc: totalBtcEqStart },
            bull: { val: valBull, btcEq: btcEqBull, pct: pctBull, totalVal: totalValBull, totalBtc: totalBtcEqBull, ammo },
            end: { totalBtc: finalBtc, totalVal: finalVal, newBtc, pct: pctEnd, multiplier }
        };
    }

    function update() {
        saveState();
        if (!state.prices.btc) return; 
        
        const data = calculate();
        
        // Render Start
        $('start-total-btc').textContent = fmt.btc(data.start.totalBtc);
        $('start-total-usd').textContent = fmt.usd(data.start.totalVal);
        $('start-btc-pct').textContent = fmt.pct(data.start.pct.btc) + ' BTC';
        $('bar-start').innerHTML = `
            <div style="width:${data.start.pct.btc}%" class="progress-segment bg-btc h-full" title="BTC: ${fmt.pct(data.start.pct.btc)}"></div>
            <div style="width:${data.start.pct.eth}%" class="progress-segment bg-eth h-full" title="ETH: ${fmt.pct(data.start.pct.eth)}"></div>
            <div style="width:${data.start.pct.ada}%" class="progress-segment bg-ada h-full" title="ADA: ${fmt.pct(data.start.pct.ada)}"></div>
        `;
        $('start-val-btc').textContent = fmt.usd(data.start.val.btc);
        $('start-qty-btc').textContent = fmt.num(state.holdings.btc, 4);
        $('start-val-eth').textContent = fmt.usd(data.start.val.eth);
        $('start-qty-eth').textContent = fmt.num(state.holdings.eth, 4);
        $('start-val-ada').textContent = fmt.usd(data.start.val.ada);
        $('start-qty-ada').textContent = fmt.num(state.holdings.ada, 0);

        // Render Bull
        $('bull-total-btc').textContent = fmt.btc(data.bull.totalBtc);
        $('bull-total-usd').textContent = fmt.usd(data.bull.totalVal);
        $('harvested-ammo').textContent = fmt.usd(data.bull.ammo);
        $('bar-bull').innerHTML = `
            <div style="width:${data.bull.pct.btc}%" class="progress-segment bg-btc h-full opacity-50" title="BTC (‰øùÁïô): ${fmt.pct(data.bull.pct.btc)}"></div>
            <div style="width:${data.bull.pct.eth}%" class="progress-segment bg-eth h-full" title="ETH: ${fmt.pct(data.bull.pct.eth)}"></div>
            <div style="width:${data.bull.pct.ada}%" class="progress-segment bg-ada h-full" title="ADA: ${fmt.pct(data.bull.pct.ada)}"></div>
        `;
        $('bull-val-btc').textContent = fmt.usd(data.bull.val.btc);
        $('bull-qty-btc').textContent = fmt.btc(data.bull.btcEq.btc);
        $('bull-val-eth').textContent = fmt.usd(data.bull.val.eth);
        $('bull-qty-eth').textContent = fmt.btc(data.bull.btcEq.eth);
        $('bull-val-ada').textContent = fmt.usd(data.bull.val.ada);
        $('bull-qty-ada').textContent = fmt.btc(data.bull.btcEq.ada);

        // Render End
        $('end-total-btc').textContent = fmt.btc(data.end.totalBtc);
        $('end-total-usd').textContent = fmt.usd(data.end.totalVal);
        $('sail-multiplier').textContent = data.end.multiplier.toFixed(2) + 'x';
        if(data.end.multiplier > 1) $('sail-multiplier').className = "text-2xl font-mono font-bold text-green-400";
        else $('sail-multiplier').className = "text-2xl font-mono font-bold text-red-400";

        $('bar-end').innerHTML = `
            <div style="width:${data.end.pct.anchor}%" class="progress-segment bg-btc h-full" title="ÂéüÂßãÈîö: ${fmt.pct(data.end.pct.anchor)}"></div>
            <div style="width:${data.end.pct.sail}%" class="progress-segment bg-usdt h-full" title="Êñ∞Ëé∑BTC: ${fmt.pct(data.end.pct.sail)}"></div>
        `;
        
        $('end-anchor-qty').textContent = fmt.btc(state.holdings.btc);
        $('end-anchor-pct').textContent = fmt.pct(data.end.pct.anchor);
        $('end-anchor-val').textContent = fmt.usd(data.end.totalVal * (data.end.pct.anchor/100));
        
        $('end-sail-qty').textContent = '+' + fmt.btc(data.end.newBtc);
        $('end-sail-pct').textContent = fmt.pct(data.end.pct.sail);
        $('end-sail-val').textContent = fmt.usd(data.end.totalVal * (data.end.pct.sail/100));

        renderChart(data);
    }

    function renderChart(data) {
        const ctx = $('growthChart').getContext('2d');
        const startSailBtcEq = data.start.btcEq.eth + data.start.btcEq.ada;

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Ëµ∑ÁÇπ (BTCÁ≠âÂÄº)', 'ÁªàÁÇπ (BTCÂÆûÁâ©)'],
                datasets: [
                    {
                        label: '‚öì Ê†∏ÂøÉÈîö (BTC)',
                        data: [state.holdings.btc, state.holdings.btc],
                        backgroundColor: '#F7931A',
                        barThickness: 60,
                        stack: 'Stack 0',
                    },
                    {
                        label: '‚õµ ‰∫§ÊòìÂ∏Ü (ÂΩìÂâçÂ±±ÂØ®)',
                        data: [startSailBtcEq, 0],
                        backgroundColor: '#627EEA',
                        barThickness: 60,
                        stack: 'Stack 0',
                    },
                    {
                        label: '‚õµ ‰∫§ÊòìÂ∏Ü (Â∏¶ÂõûÂà©Ê∂¶)',
                        data: [0, data.end.newBtc],
                        backgroundColor: '#26A17B',
                        barThickness: 60,
                        stack: 'Stack 0',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top', labels: { color: '#9ca3af', font: { family: 'Inter' } } },
                    tooltip: {
                        backgroundColor: 'rgba(20,20,20,0.9)',
                        titleColor: '#fff',
                        bodyColor: '#ccc',
                        borderWidth: 1,
                        borderColor: 'rgba(255,255,255,0.1)',
                        callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.raw.toFixed(4)} BTC` }
                    }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#666' } },
                    y: { grid: { color: '#333' }, ticks: { color: '#666' }, beginAtZero: true }
                }
            }
        });
    }

    window.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
