<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>锚与帆 | 深度实战推演 v6.0 (精准时间轴版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        btc: '#F7931A',
                        eth: '#8B5CF6',
                        ada: '#2563EB',
                        usdt: '#10B981',
                        life: '#EC4899',
                        house: '#F97316', 
                        family: '#8B5CF6',
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F3F4F6; color: #111827; font-family: 'Inter', sans-serif; }
        .panel { background: #FFF; border: 1px solid #E5E7EB; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .input-field { background: transparent; outline: none; width: 100%; font-family: 'JetBrains Mono', monospace; font-weight: 600; }
        .input-group { background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 0.5rem; transition: all 0.2s; }
        .input-group:focus-within { background: #FFF; border-color: #9CA3AF; box-shadow: 0 0 0 3px rgba(229, 231, 235, 0.5); }
        .num-font { font-family: 'JetBrains Mono', monospace; }
        .connector-line { border-left: 2px dashed #D1D5DB; margin-left: 1.5rem; height: 2rem; }
        .bar-segment { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #4B5563; cursor: pointer; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #E5E7EB; border-radius: 2px; }
    </style>
</head>
<body class="min-h-screen p-6 md:p-10 text-sm">

    <div class="max-w-[1600px] mx-auto space-y-8">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-6 pb-6 border-b border-gray-200">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-white border border-gray-200 rounded-2xl flex items-center justify-center text-btc shadow-soft">
                    <i class="ph-fill ph-hourglass-high text-3xl text-blue-600"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 tracking-tight">锚与帆 <span class="text-gray-400 font-normal text-sm ml-2 bg-gray-100 px-2 py-0.5 rounded-full">v6.0 Time & Ratio</span></h1>
                    <p class="text-gray-500 text-xs font-medium mt-0.5">精准时间轴 (2026/2030/2034) | 资产占比透视</p>
                </div>
            </div>
            
            <div class="flex items-center gap-6 bg-white px-6 py-3 rounded-2xl border border-gray-200 shadow-soft">
                <div class="flex items-center gap-5 text-xs num-font font-bold text-gray-600">
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-btc"></span> BTC <span id="price-btc" class="text-gray-900">$--</span></span>
                    <span class="text-gray-300">|</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-eth"></span> ETH <span id="price-eth" class="text-gray-900">$--</span></span>
                    <span class="text-gray-300">|</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-ada"></span> ADA <span id="price-ada" class="text-gray-900">$--</span></span>
                </div>
                <div class="w-px h-6 bg-gray-200"></div>
                <div class="flex flex-col items-end leading-none">
                    <span class="text-[10px] text-gray-400 uppercase font-bold">Ahr999 Index</span>
                    <span class="text-base num-font font-bold text-gray-800" id="ahr-value">--</span>
                </div>
                <button id="refresh-btn" class="p-1.5 hover:bg-gray-100 rounded-lg text-gray-400 transition-colors">
                    <i class="ph-bold ph-arrows-clockwise text-lg"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
            
            <!-- 左侧：控制台 (3列) -->
            <div class="xl:col-span-3 space-y-6">
                
                <!-- 1. Cycle 1 实战 -->
                <div class="panel p-5">
                    <h2 class="text-gray-900 font-bold mb-4 flex items-center gap-2 text-xs uppercase tracking-wider border-b border-gray-100 pb-2">
                        <i class="ph-bold ph-crosshair text-blue-600"></i> Cycle 1 实战
                    </h2>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] text-gray-400 font-bold uppercase">当前持仓</span>
                            <span class="text-[10px] text-blue-500 bg-blue-50 px-1.5 rounded cursor-pointer hover:bg-blue-100">Auto-saved</span>
                        </div>
                        <div class="input-group px-3 py-2 flex justify-between border-l-4 border-l-btc">
                            <label class="text-xs font-bold text-gray-500">BTC</label>
                            <input type="number" id="currentBtc" class="input-field text-right" placeholder="0.00">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="input-group px-3 py-2 border-l-4 border-l-eth">
                                <label class="text-[10px] font-bold text-gray-500 block">ETH</label>
                                <input type="number" id="currentEth" class="input-field text-right text-xs">
                            </div>
                            <div class="input-group px-3 py-2 border-l-4 border-l-ada">
                                <label class="text-[10px] font-bold text-gray-500 block">ADA</label>
                                <input type="number" id="currentAda" class="input-field text-right text-xs">
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="text-[10px] text-gray-400 font-bold uppercase">本轮目标</div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="input-group px-3 py-2">
                                <label class="text-[10px] text-gray-500 block mb-1">牛顶 ETH</label>
                                <input type="number" id="bullEthPrice" class="input-field text-sm" value="8000">
                            </div>
                            <div class="input-group px-3 py-2">
                                <label class="text-[10px] text-gray-500 block mb-1">牛顶 ADA</label>
                                <input type="number" id="bullAdaPrice" class="input-field text-sm" value="5">
                            </div>
                        </div>
                        <div class="input-group px-3 py-2">
                            <label class="text-[10px] text-gray-500 block mb-1">牛顶 BTC (计价)</label>
                            <input type="number" id="bullBtcPrice" class="input-field text-sm text-gray-600" value="150000">
                        </div>
                        <div class="input-group px-3 py-2 border-l-4 border-l-usdt bg-green-50/50 border-green-200">
                            <label class="text-xs text-gray-600 font-bold block mb-1">熊底 BTC 接回价</label>
                            <input type="number" id="bearBuyPrice" class="input-field text-lg font-bold text-green-700" value="69000">
                        </div>
                    </div>
                </div>

                <!-- 2. 人生开销预算 -->
                <div class="panel p-5 bg-white border-l-4 border-l-life">
                    <h2 class="text-gray-900 font-bold mb-4 flex items-center gap-2 text-xs uppercase tracking-wider border-b border-gray-100 pb-2">
                        <i class="ph-bold ph-heart text-life"></i> 人生/家庭预算
                    </h2>
                    <div class="space-y-3">
                        <div class="input-group px-3 py-2">
                            <label class="text-[10px] text-gray-500 block mb-1 flex justify-between">
                                <span>西昌居住改善 (装修/适老)</span>
                                <span class="text-family font-bold">~2026</span>
                            </label>
                            <div class="flex items-center gap-1">
                                <span class="text-gray-400">$</span>
                                <input type="number" id="costMomHouse" class="input-field text-sm text-family" value="10000">
                            </div>
                        </div>
                        <div class="input-group px-3 py-2">
                            <label class="text-[10px] text-gray-500 block mb-1 flex justify-between">
                                <span>2030 冻卵</span>
                                <span class="text-life font-bold">~2030</span>
                            </label>
                            <div class="flex items-center gap-1">
                                <span class="text-gray-400">$</span>
                                <input type="number" id="costEgg" class="input-field text-sm text-life" value="20000">
                            </div>
                        </div>
                        <div class="input-group px-3 py-2">
                            <label class="text-[10px] text-gray-500 block mb-1 flex justify-between">
                                <span>父母医疗储备金</span>
                                <span class="text-red-500 font-bold">备用</span>
                            </label>
                            <div class="flex items-center gap-1">
                                <span class="text-gray-400">$</span>
                                <input type="number" id="costMedical" class="input-field text-sm text-red-500" value="30000">
                            </div>
                        </div>
                        <div class="input-group px-3 py-2">
                            <label class="text-[10px] text-gray-500 block mb-1 flex justify-between">
                                <span>上海置业储备</span>
                                <span class="text-house font-bold">长期</span>
                            </label>
                            <div class="flex items-center gap-1">
                                <span class="text-gray-400">$</span>
                                <input type="number" id="costShanghai" class="input-field text-sm text-house" value="500000">
                            </div>
                        </div>
                        <div class="input-group px-3 py-2">
                            <label class="text-[10px] text-gray-500 block mb-1 flex justify-between">
                                <span>2034 美国代孕</span>
                                <span class="text-life font-bold">~2034</span>
                            </label>
                            <div class="flex items-center gap-1">
                                <span class="text-gray-400">$</span>
                                <input type="number" id="costSurrogacy" class="input-field text-sm text-life" value="200000">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. 宏观配置 -->
                <div class="panel p-5 bg-gray-50">
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-xs font-bold text-red-600">摩擦系数 (Friction)</label>
                                <span class="text-xs font-mono font-bold text-red-600" id="disp-friction">20%</span>
                            </div>
                            <input type="range" id="friction" min="0" max="40" step="5" value="20" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-red-600">
                            <p class="text-[10px] text-gray-400 mt-1">扣除 <span id="friction-val" class="font-bold text-red-500">20%</span> 利润 (税务/滑点/损耗)</p>
                        </div>
                        <hr class="border-gray-200">
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-xs font-bold text-gray-600">未来帆仓位 (50%)</label>
                                <span class="text-xs font-mono font-bold text-blue-600" id="disp-sail-alloc">50%</span>
                            </div>
                            <input type="range" id="sailAlloc" min="30" max="80" step="5" value="50" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                            <p class="text-[10px] text-gray-400 mt-1">默认: <span class="font-bold text-btc">50% 压舱</span> / <span class="font-bold text-blue-600">50% 进攻</span></p>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-xs font-bold text-gray-600">机会收窄 (急速 35%)</label>
                                <span class="text-xs font-mono font-bold text-purple-600" id="disp-decay">35%</span>
                            </div>
                            <input type="range" id="alphaDecay" min="0" max="60" step="5" value="35" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600">
                             <p class="text-[10px] text-gray-400 mt-1">每轮超额收益减少 <span id="decay-val" class="font-bold text-purple-500">35%</span></p>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-xs font-bold text-gray-600">推演轮次</label>
                                <span class="text-xs font-mono font-bold text-gray-800" id="disp-cycles">3 Cycles</span>
                            </div>
                            <input type="range" id="simCycles" min="2" max="5" step="1" value="3" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-gray-600">
                        </div>
                    </div>
                </div>

            </div>

            <!-- 右侧：推演详情 (9列) -->
            <div class="xl:col-span-9 space-y-8">
                
                <!-- SECTION A: Cycle 1 详细透视 (比例柱回归) -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded">CYCLE 1 (2025)</span>
                        <span class="text-sm font-bold text-gray-700">本轮实战详情</span>
                    </div>

                    <!-- 1. 起点 -->
                    <div class="panel p-5 flex flex-col gap-4 relative overflow-hidden">
                        <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-500"></div>
                        
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-[10px] text-gray-400 uppercase font-bold">Phase 1: 起点 (当前)</div>
                                <div class="text-2xl font-mono font-bold text-gray-900" id="c1-start-btc">-- BTC</div>
                                <div class="text-xs text-gray-500 font-mono" id="c1-start-usd">$ --</div>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] text-gray-400 uppercase font-bold">资产占比 (Value)</div>
                                <div class="flex gap-2 mt-1" id="c1-start-pcts">
                                    <!-- JS Injected -->
                                </div>
                            </div>
                        </div>

                        <!-- 比例柱 -->
                        <div class="w-full h-4 bg-gray-100 rounded-full overflow-hidden flex shadow-inner text-[9px] text-white font-bold leading-4 text-center" id="bar-start">
                            <!-- JS Injected -->
                        </div>
                    </div>

                    <!-- 2. 牛顶 -->
                    <div class="panel p-5 flex flex-col gap-4 relative border-l-4 border-l-red-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-[10px] text-red-500 uppercase font-bold">Phase 2: 牛顶 (卖出前)</div>
                                <div class="text-2xl font-mono font-bold text-gray-900" id="c1-bull-btc">-- BTC</div>
                                <div class="text-xs text-gray-500 font-mono">Val: <span id="c1-bull-usd">--</span></div>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] text-gray-400 uppercase font-bold">牛顶市值占比</div>
                                <div class="flex gap-2 mt-1" id="c1-bull-pcts">
                                    <!-- JS Injected -->
                                </div>
                            </div>
                        </div>

                        <!-- 比例柱 -->
                        <div class="w-full h-4 bg-gray-100 rounded-full overflow-hidden flex shadow-inner text-[9px] text-white font-bold leading-4 text-center" id="bar-bull">
                            <!-- JS Injected -->
                        </div>

                        <div class="flex justify-between items-center pt-2 border-t border-gray-50">
                            <div class="text-xs text-gray-400">
                                <i class="ph-bold ph-arrow-right"></i> 卖出所有 ETH/ADA，保留 BTC
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] text-green-600 font-bold uppercase">收获 USDT</div>
                                <div class="text-lg font-mono font-black text-green-600" id="c1-ammo">$--</div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. 熊底 -->
                    <div class="panel p-5 flex flex-col gap-4 border-l-4 border-l-usdt bg-gradient-to-r from-green-50/30 to-white">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-[10px] text-green-600 uppercase font-bold">Phase 3: 熊底 (~2026)</div>
                                <div class="text-3xl font-mono font-bold text-gray-900" id="c1-end-btc">-- BTC</div>
                                <div class="text-xs text-gray-500 font-mono">Val: <span id="c1-end-usd">--</span></div>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] text-gray-400 uppercase font-bold">BTC 筹码构成</div>
                                <div class="flex gap-2 mt-1" id="c1-end-pcts">
                                    <!-- JS Injected -->
                                </div>
                            </div>
                        </div>

                        <!-- 比例柱 -->
                        <div class="w-full h-4 bg-gray-100 rounded-full overflow-hidden flex shadow-inner text-[9px] text-white font-bold leading-4 text-center" id="bar-end">
                            <!-- JS Injected -->
                        </div>
                    </div>
                </div>

                <!-- SECTION B: 宏观未来 (带时间轴) -->
                <div class="space-y-4 pt-6 border-t border-gray-200">
                    <div class="flex justify-between items-end">
                        <div class="flex items-center gap-2">
                            <span class="bg-purple-600 text-white text-xs font-bold px-2 py-0.5 rounded">MACRO</span>
                            <span class="text-sm font-bold text-gray-700">财富时间轴 (2025-2034)</span>
                        </div>
                    </div>

                    <!-- 宏观图表 -->
                    <div class="panel p-6 h-80 bg-white">
                        <canvas id="macroChart"></canvas>
                    </div>
                    
                    <!-- 人生目标进度条 (Reuse existing logic) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div class="panel p-4 border-l-4 border-l-family">
                            <div class="flex justify-between mb-1"><span class="text-xs font-bold">妈妈装修 (2026)</span><span class="text-xs font-mono" id="disp-mom-total">--</span></div>
                            <div class="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden"><div id="bar-mom" class="h-full bg-family" style="width:0%"></div></div>
                            <div class="text-[10px] text-right mt-1 text-gray-400" id="pct-mom">--</div>
                        </div>
                        <div class="panel p-4 border-l-4 border-l-life">
                            <div class="flex justify-between mb-1"><span class="text-xs font-bold">2030 冻卵</span><span class="text-xs font-mono" id="disp-egg-cost">--</span></div>
                            <div class="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden"><div id="bar-egg" class="h-full bg-life" style="width:0%"></div></div>
                            <div class="text-[10px] text-right mt-1 text-gray-400" id="pct-egg">--</div>
                        </div>
                        <div class="panel p-4 border-l-4 border-l-house">
                            <div class="flex justify-between mb-1"><span class="text-xs font-bold">上海置业储备</span><span class="text-xs font-mono" id="disp-shanghai-cost">--</span></div>
                            <div class="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden"><div id="bar-shanghai" class="h-full bg-house" style="width:0%"></div></div>
                            <div class="text-[10px] text-right mt-1 text-gray-400" id="pct-shanghai">--</div>
                        </div>
                        <div class="panel p-4 border-l-4 border-l-life">
                            <div class="flex justify-between mb-1"><span class="text-xs font-bold">2034 代孕</span><span class="text-xs font-mono" id="disp-surro-cost">--</span></div>
                            <div class="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden"><div id="bar-surro" class="h-full bg-life" style="width:0%"></div></div>
                            <div class="text-[10px] text-right mt-1 text-gray-400" id="pct-surro">--</div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>

<script>
    // --- State ---
    const state = {
        holdings: { btc: 0.0871, eth: 4.5603, ada: 45029.7432 },
        prices: { btc: 0, eth: 0, ada: 0 },
        targets: { btc: 150000, eth: 8000, ada: 5 },
        bear: { buyPrice: 69000 },
        macro: { decay: 0.35, cycles: 3, sailAlloc: 0.50, friction: 0.20 },
        life: { costMomHouse: 10000, costMedical: 30000, costEgg: 20000, costShanghai: 500000, costSurrogacy: 200000 },
        ahr: { value: 0 }
    };

    // --- DOM & Vars ---
    const $ = (id) => document.getElementById(id);
    let chartInstance = null;

    // --- Formatter ---
    const fmt = {
        usd: (n, d=0) => '$' + new Intl.NumberFormat('en-US', { maximumFractionDigits: d }).format(n),
        btc: (n, d=4) => new Intl.NumberFormat('en-US', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n),
        num: (n, d=2) => new Intl.NumberFormat('en-US', { maximumFractionDigits: d }).format(n),
        pct: (n, d=1) => n.toFixed(d) + '%'
    };

    // --- Init ---
    function init() {
        loadState();
        bindEvents();
        updateInputs();
        fetchData();
    }

    function updateInputs() {
        const setVal = (id, val) => { const el = $(id); if(el) el.value = val; };
        const setTxt = (id, txt) => { const el = $(id); if(el) el.textContent = txt; };
        
        setVal('currentBtc', state.holdings.btc);
        setVal('currentEth', state.holdings.eth);
        setVal('currentAda', state.holdings.ada);
        setVal('bullBtcPrice', state.targets.btc);
        setVal('bullEthPrice', state.targets.eth);
        setVal('bullAdaPrice', state.targets.ada);
        setVal('bearBuyPrice', state.bear.buyPrice);
        setVal('alphaDecay', state.macro.decay * 100);
        setVal('sailAlloc', state.macro.sailAlloc * 100);
        setVal('simCycles', state.macro.cycles);
        setVal('friction', state.macro.friction * 100);
        setVal('costMomHouse', state.life.costMomHouse);
        setVal('costMedical', state.life.costMedical);
        setVal('costEgg', state.life.costEgg);
        setVal('costShanghai', state.life.costShanghai);
        setVal('costSurrogacy', state.life.costSurrogacy);
        
        const dispDecay = $('disp-decay'); if(dispDecay) dispDecay.textContent = (state.macro.decay * 100) + '%';
        const decayVal = $('decay-val'); if(decayVal) decayVal.textContent = (state.macro.decay * 100) + '%';
        const dispSail = $('disp-sail-alloc'); if(dispSail) dispSail.textContent = (state.macro.sailAlloc * 100) + '%';
        const lblSail = $('lbl-sail-alloc'); if(lblSail) lblSail.textContent = (state.macro.sailAlloc * 100) + '%';
        const dispCycles = $('disp-cycles'); if(dispCycles) dispCycles.textContent = state.macro.cycles + ' Cycles';
        const dispFric = $('disp-friction'); if(dispFric) dispFric.textContent = (state.macro.friction * 100) + '%';
        const fricVal = $('friction-val'); if(fricVal) fricVal.textContent = (state.macro.friction * 100) + '%';
    }

    function bindEvents() {
        const onIn = (id, cb) => { const el = $(id); if(el) el.addEventListener('input', cb); };
        ['currentBtc', 'currentEth', 'currentAda'].forEach(k => onIn(k, e => { state.holdings[k.replace('current','').toLowerCase()] = parseFloat(e.target.value) || 0; update(); }));
        ['bullBtcPrice', 'bullEthPrice', 'bullAdaPrice'].forEach(k => onIn(k, e => { const key = k.replace('bull','').replace('Price','').toLowerCase(); state.targets[key] = parseFloat(e.target.value) || 0; update(); }));
        onIn('bearBuyPrice', e => { state.bear.buyPrice = parseFloat(e.target.value) || 0; update(); });
        onIn('alphaDecay', e => { state.macro.decay = parseInt(e.target.value) / 100; updateInputs(); update(); });
        onIn('sailAlloc', e => { state.macro.sailAlloc = parseInt(e.target.value) / 100; updateInputs(); update(); });
        onIn('simCycles', e => { state.macro.cycles = parseInt(e.target.value); updateInputs(); update(); });
        onIn('friction', e => { state.macro.friction = parseInt(e.target.value) / 100; updateInputs(); update(); });
        ['costMomHouse', 'costMedical', 'costEgg', 'costShanghai', 'costSurrogacy'].forEach(k => onIn(k, e => { state.life[k] = parseFloat(e.target.value) || 0; update(); }));
        const btn = $('refresh-btn'); if(btn) btn.addEventListener('click', fetchData);
    }

    const STORAGE_KEY = 'gemini_sail_v6_0';
    function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function loadState() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            state.holdings = { ...state.holdings, ...parsed.holdings };
            state.targets = { ...state.targets, ...parsed.targets };
            state.bear = { ...state.bear, ...parsed.bear };
            state.macro = { ...state.macro, ...parsed.macro };
            if(parsed.life) state.life = { ...state.life, ...parsed.life };
        }
    }

    async function fetchData() {
        const btn = $('refresh-btn'); if(btn) btn.classList.add('animate-spin');
        try {
            const resPrice = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,cardano&vs_currencies=usd');
            const dataPrice = await resPrice.json();
            state.prices = { btc: dataPrice.bitcoin.usd, eth: dataPrice.ethereum.usd, ada: dataPrice.cardano.usd };
            const resHist = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=200&interval=daily');
            const dataHist = await resHist.json();
            const prices = dataHist.prices.map(p => p[1]);
            const ma200 = prices.reduce((a, b) => a + b, 0) / prices.length;
            const genesisDate = new Date('2009-01-03');
            const daysSinceGenesis = (new Date() - genesisDate) / (1000 * 60 * 60 * 24);
            const fittingPrice = Math.pow(10, (5.84 * Math.log10(daysSinceGenesis) - 17.01));
            state.ahr.value = (state.prices.btc / ma200) * (state.prices.btc / fittingPrice);
            renderHeader();
            update();
        } catch (e) { console.error(e); } finally { if(btn) btn.classList.remove('animate-spin'); }
    }

    function renderHeader() {
        const setTxt = (id, txt) => { const el = $(id); if(el) el.textContent = txt; };
        setTxt('price-btc', fmt.usd(state.prices.btc));
        setTxt('price-eth', fmt.usd(state.prices.eth));
        setTxt('price-ada', fmt.usd(state.prices.ada, 3));
        setTxt('ahr-value', state.ahr.value.toFixed(2));
    }

    function update() {
        saveState();
        if (!state.prices.btc) return;

        // --- Cycle 1 Calculation ---
        const c1_val_btc = state.holdings.btc * state.prices.btc;
        const c1_val_eth = state.holdings.eth * state.prices.eth;
        const c1_val_ada = state.holdings.ada * state.prices.ada;
        const c1_start_usd = c1_val_btc + c1_val_eth + c1_val_ada;
        const c1_start_btc_eq = c1_start_usd / state.prices.btc;
        
        const pct_start_btc = c1_val_btc / c1_start_usd * 100;
        const pct_start_eth = c1_val_eth / c1_start_usd * 100;
        const pct_start_ada = c1_val_ada / c1_start_usd * 100;

        const c1_bull_eth = state.holdings.eth * state.targets.eth;
        const c1_bull_ada = state.holdings.ada * state.targets.ada;
        const c1_bull_btc = state.holdings.btc * state.targets.btc;
        let c1_ammo = c1_bull_eth + c1_bull_ada;
        const friction = 1 - state.macro.friction;
        c1_ammo *= friction;
        
        const c1_bull_usd = c1_bull_btc + (c1_bull_eth + c1_bull_ada); // Pre-friction value for chart
        const pct_bull_btc = c1_bull_btc / c1_bull_usd * 100;
        const pct_bull_eth = c1_bull_eth / c1_bull_usd * 100;
        const pct_bull_ada = c1_bull_ada / c1_bull_usd * 100;

        const c1_new_btc = c1_ammo / state.bear.buyPrice;
        const c1_end_btc = state.holdings.btc + c1_new_btc;
        const c1_end_usd = c1_end_btc * state.bear.buyPrice;

        const pct_end_anchor = (state.holdings.btc / c1_end_btc) * 100;
        const pct_end_sail = (c1_new_btc / c1_end_btc) * 100;

        const sail_start_btc_eq = (c1_val_eth + c1_val_ada) / state.prices.btc;
        const c1_alpha = sail_start_btc_eq > 0 ? c1_new_btc / sail_start_btc_eq : 1;

        // --- Macro Loop ---
        const chartLabels = ['起点 (2025)'];
        const chartData = [c1_start_btc_eq];
        const annotations = {};
        
        let currentBtc = c1_end_btc;
        let currentAlpha = c1_alpha;
        let currentBearPrice = state.bear.buyPrice;
        
        chartLabels.push('2026 (C1底)');
        chartData.push(c1_end_btc);
        
        // Life Goals Values
        let valCycle2 = 0, valCycle3 = 0;

        for(let i=2; i<=state.macro.cycles; i++) {
            const endYear = 2026 + (i-1)*4; 
            chartLabels.push(`${endYear} (C${i}底)`);
            
            currentAlpha = 1 + ((currentAlpha - 1) * (1 - state.macro.decay));
            if(currentAlpha < 1) currentAlpha = 1;
            
            const sailRatio = state.macro.sailAlloc;
            const anchorRatio = 1 - sailRatio;
            const anchor = currentBtc * anchorRatio;
            const sail = currentBtc * sailRatio;
            const newSail = (sail * currentAlpha) * friction;
            currentBtc = anchor + newSail;
            
            chartData.push(currentBtc);
            currentBearPrice *= 1.5; 

            if (i === 2) { // 2030
                valCycle2 = currentBtc * currentBearPrice; 
                annotations['goal2030'] = { index: 2, label: '2030: 冻卵' };
            }
            if (i === 3) { // 2034
                valCycle3 = currentBtc * currentBearPrice;
                annotations['goal2034'] = { index: 3, label: '2034: 代孕' };
            }
        }

        // --- Render UI ---
        const setTxt = (id, txt) => { const el = $(id); if(el) el.textContent = txt; };
        setTxt('c1-start-btc', fmt.btc(c1_start_btc_eq));
        setTxt('c1-start-usd', fmt.usd(c1_start_usd));
        
        // Start Bars
        $('c1-start-pcts').innerHTML = `<span class="text-xs font-bold text-btc">${fmt.pct(pct_start_btc)}</span> <span class="text-xs font-bold text-eth">${fmt.pct(pct_start_eth)}</span> <span class="text-xs font-bold text-ada">${fmt.pct(pct_start_ada)}</span>`;
        $('bar-start').innerHTML = `<div style="width:${pct_start_btc}%" class="bar-segment bg-btc h-full flex items-center justify-center" title="BTC">BTC</div><div style="width:${pct_start_eth}%" class="bar-segment bg-eth h-full flex items-center justify-center" title="ETH">ETH</div><div style="width:${pct_start_ada}%" class="bar-segment bg-ada h-full flex items-center justify-center" title="ADA">ADA</div>`;

        // Bull Bars
        setTxt('c1-bull-btc', fmt.btc(c1_bull_usd/state.targets.btc));
        setTxt('c1-bull-usd', fmt.usd(c1_bull_usd));
        $('c1-bull-pcts').innerHTML = `<span class="text-xs font-bold text-btc">${fmt.pct(pct_bull_btc)}</span> <span class="text-xs font-bold text-eth">${fmt.pct(pct_bull_eth)}</span> <span class="text-xs font-bold text-ada">${fmt.pct(pct_bull_ada)}</span>`;
        $('bar-bull').innerHTML = `<div style="width:${pct_bull_btc}%" class="bar-segment bg-btc h-full opacity-60 flex items-center justify-center">BTC</div><div style="width:${pct_bull_eth}%" class="bar-segment bg-eth h-full flex items-center justify-center">ETH</div><div style="width:${pct_bull_ada}%" class="bar-segment bg-ada h-full flex items-center justify-center">ADA</div>`;
        setTxt('c1-ammo', fmt.usd(c1_ammo));

        // End Bars
        setTxt('c1-end-btc', fmt.btc(c1_end_btc));
        setTxt('c1-end-usd', fmt.usd(c1_end_usd));
        $('c1-end-pcts').innerHTML = `<span class="text-xs font-bold text-btc">${fmt.pct(pct_end_anchor)}</span> <span class="text-xs font-bold text-usdt">${fmt.pct(pct_end_sail)}</span>`;
        $('bar-end').innerHTML = `<div style="width:${pct_end_anchor}%" class="bar-segment bg-btc h-full flex items-center justify-center">老本</div><div style="width:${pct_end_sail}%" class="bar-segment bg-usdt h-full flex items-center justify-center">利润</div>`;

        // Life Goals
        const renderBar = (barId, pctId, cost, assetVal, statusId) => {
            const pct = assetVal > 0 ? (cost / assetVal) * 100 : 0;
            const bar = $(barId); if(bar) bar.style.width = Math.min(pct, 100) + '%';
            setTxt(pctId, pct.toFixed(2) + '%');
        };
        
        const momTotal = state.life.costMomHouse + state.life.costMedical;
        setTxt('disp-mom-total', fmt.usd(momTotal));
        renderBar('bar-mom', 'pct-mom', momTotal, c1_end_usd, null);
        setTxt('disp-egg-cost', fmt.usd(state.life.costEgg));
        renderBar('bar-egg', 'pct-egg', state.life.costEgg, valCycle2, null);
        setTxt('disp-shanghai-cost', fmt.usd(state.life.costShanghai));
        renderBar('bar-shanghai', 'pct-shanghai', state.life.costShanghai, valCycle3, null);
        setTxt('disp-surro-cost', fmt.usd(state.life.costSurrogacy));
        renderBar('bar-surro', 'pct-surro', state.life.costSurrogacy, valCycle3, null);

        renderChart(chartLabels, chartData, annotations);
    }

    function renderChart(labels, data, annotations) {
        const ctx = $('macroChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        const brandColor = '#2563EB';

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'BTC 复利增长 (Real BTC)',
                    data: data,
                    borderColor: brandColor,
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: true,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: brandColor,
                    pointRadius: 6,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { family: 'Inter' }, usePointStyle: true } },
                    tooltip: {
                        backgroundColor: 'rgba(17, 24, 39, 0.9)',
                        titleColor: '#fff',
                        bodyFont: { family: 'JetBrains Mono' },
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.raw.toFixed(2)} BTC` }
                    },
                    annotation: {
                        annotations: Object.keys(annotations).map(key => ({
                            type: 'line',
                            scaleID: 'x',
                            value: annotations[key].index,
                            borderColor: '#EC4899',
                            borderWidth: 1,
                            borderDash: [4, 4],
                            label: {
                                display: true,
                                content: annotations[key].label,
                                position: 'start',
                                backgroundColor: '#EC4899',
                                color: 'white',
                                font: { size: 10, weight: 'bold' }
                            }
                        }))
                    }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { family: 'Inter' }, color: '#6B7280' } },
                    y: { grid: { color: '#F3F4F6' }, ticks: { font: { family: 'JetBrains Mono' }, color: '#6B7280' } }
                }
            }
        });
    }

    window.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
